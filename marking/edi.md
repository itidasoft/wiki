---
title: Работа с системами ЭДО
description: Приёмка и отгрузка маркированных товаров через ЭДО
published: true
date: 2022-09-06T10:40:01.771Z
tags: эдо, отгрузка, приемка
editor: markdown
dateCreated: 2022-07-29T22:39:36.718Z
---

Методология ГИС МТ не подразумевает работу через API системы с табачной продукцией. Так же, работа с другими товарными группами (поступление и отгрузка) возможны с использованием системы электронного документооборота. Вся работа с движением кодов маркировки продукции осуществляется операторами систем ЭДО. Поэтому возможны только получение входящих УПД и отправка исходящих УПД.

Настройка модуля Маркировка для работы с системами ЭДО производится в окне **Параметры обмена с ГИС Маркировка**.

![](/images/marking/edi/b4ce6c72d74f09d1536ec343f09b3d27.png)

Так как работа по API не производится, параметры **ИД СУЗ**, **Токен клиента**, **Номер договора**, **Дата договора** заполнять не требуется. Сертификат необходимо выбрать, если предполагается прямое подключение к системе ЭДО. Выбранный сертификат должен быть зарегистрирован в системе ЭДО для электронной подписи документов. Обязательно нужно выбрать фирму и склад. С этими параметрами будут формировать приходные накладные на основании полученных УПД. Параметр **Группа маркировки** при работе с системой ЭДО не используется. Если выбрать папки для новых товаров и контрагентов, то создаваемые карточки будут сразу помещаться в эти папки.

>   Для товаров в выбранной папке может быть указана группа ресурсов. В таком случае, при создании новых товаров будут автоматически заполнены поля новых карточек такие как:
> - Группу товара;
> - Код налога;
> - Признак и группа маркировки;
> - Единица измерения и т.п..
{.is-info}

Для работы с системами ЭДО в Айтиде в настройке модуля Маркировка предусмотрен раздел, с соответствующими параметрами.

![](/images/marking/edi/ff73d5830140774bcbac9308baf7585e.png)

Для активации параметров необходимо установить признак Использовать ЭДО.

В поле **Оператор ЭДО** необходимо выбрать оператора ЭДО, к которому подключен клиент. Список операторов постепенно расширяется. Если необходимого оператора ЭДО нет в списке, то это значит, что пока у Айтиды нет профиля для работы с ним. В этом случае, не нужно выбирать никакого другого оператора и заполнять другие поля. Пока в Айтиде не будет нужного профиля можно загружать УПД через функционал **Загрузка УПД из файла XML**.

В полях **Пользователь** и **Пароль** указываются учетные данные для входа в систему ЭДО, выбранного оператора.

Если оператор ЭДО позволяет с одними учетными данными регистрировать несколько аккаунтов, то необходимый аккаунт нужно указать в поле **Аккаунт**.

В поле **Дата загрузки** записывается дата последнего загруженного документа. Поле доступно для корректировки и позволяет, при необходимости, загрузить документы с более ранней даты, отстоящей от текущей не более чем на 30 дней.

Если установлен признак **Принимать только УПД с маркировкой**, то при приеме документы будут отфильтрованы по наличию в них тэгов, относящихся к маркировке:

-   КИЗ;
-   НомУпак;
-   ИдентТрансУпак.

Если признак снят, то будут приниматься все входящие УПД.

>   При загрузке из ЭДО в Айтиду будут добавляться только те документы. У которых статус в системе ЭДО не подтвержден и не отказан. Подтвержденные и отказанные УПД загружаться не будут.
{.is-warning}


В разделе **Подписант документов** необходимо указать ФИО и должность лица, уполномоченного подписывать документы.

>   При работе с системой ЭДО так же используются параметры с закладки **Основные параметры**. Выбранный на ней сертификат должен быть зарегистрирован в выбранной системе ЭДО.
{.is-warning}


Кнопка **Проверка входящих** позволяет ввести скрипт проверки каждого загружаемого документа. Если будет задан такой скрипт, то он будет вычисляться для каждого полученного из системы ЭДО документа. Если вычисление вернет значение Истина, то документ будет загружен. Иначе, будет пропущен и пользователю будет сообщено, что часть документов была пропущена, т.к. не прошла по фильтру. Задание такой проверки необходимо, например, если есть несколько торговых точек и в каждой необходимо принимать только необходимые в этой точке документы.

Для анализа загружаемого документа скрипт может использовать переменные, имена которых составлены из названий тэгов принимаемого XML файла.

Например, для доступа к улице из адреса грузополучателя можно использовать переменную *Файл_Документ_СвСчФакт_ГрузПолуч_Адрес_АдрРФ_Улица.*
![](/images/marking/edi/bef02a9e9c9053b38fdafba1a977d5cc.png)

Проанализировать её значение, например, на вхождение в название улицы в адресе грузополучателя слова «Красная», и если такое вхождение есть, то загрузить документ.

```js
RETURN “красная”$LOWER(Файл_Документ_СвСчФакт_ГрузПолуч_Адрес_АдрРФ_Улица );
```

>   Для упрощения доступа к наиболее часто используемым переменным в систему добавлены специальные понятия:
{.is-info}


![](/images/marking/edi/d0e98ad51bc2a947b719d70132030048.png)

>   Часть тэгов в файлах является не обязательной для указания. В случае, если тэга нет в принимаемом файле, соответствующая переменная не будет определена. Анализ значения такой переменной приведет к ошибке вычисления и документ будет пропущен. Для предотвращения таких ситуаций рекомендуется использовать функцию **ПЕРЕМЕННАЯ( ИмяПеременной[,ЗначениеПоУмолчанию])** для безошибочного вычисления значения переменной.
{.is-info}

С учетом этого замечания, выражение из примера с названием улицы в адресе принимает следующий вид:
```js
RETURN “красная”$LOWER( ПЕРЕМЕННАЯ( "Файл_Документ_СвСчФакт_ГрузПолуч_Адрес_АдрРФ_Улица", "" ) );
```


# Получение входящих УПД.

Для загрузки входящих УПД в модуле Маркировка необходимо перейти на закладку **Поставки**.

![](/images/marking/edi/ea1388ae6952d3c072c371e5f7a061cd.png)

Нажатие кнопки **Загрузить входящие УПД** вызовет процедуру загрузки УПД из системы ЭДО. Айтида отправляет запрос в систему ЭДО на поиск изменений документов начиная (включительно) с даты, указанной в параметрах модуля, по текущий момент. Если указанная в параметрах дата отстоит от текущей более чем на 30 дней, то запрос ограничивается последними тридцатью днями.

Если во входящих документах есть еще не обработанные УПД, то они будут загружены в Айтиду. Во время загрузки документы идентифицируются по идентификаторам, предоставляемым системой ЭДО. Документы с одинаковыми идентификаторами пропускаются. Если система ЭДО поддерживает версионность документов (редакции, например СБИС), то разные редакции рассматриваются Айтидой как разные документы и по отдельности загружаются в систему. При этом, номер начальной редакции соответствует номеру документа, который присвоил поставщик. К последующим редакциям добавляется суффикс /РЕДN – где N номер редакции.

Если возникла необходимость в повторной загрузке документа, то предварительно нужно удалить ранее загруженный вариант документа.

В случае успешного обмена данными с системой ЭДО будет выведено сообщение об успешной загрузке некоторого количества документов, либо сообщение о том, что новые документы не найдены.

![](/images/marking/edi/b04455cc8f8c20bfa37825565625aa7b.png)

Если во время обмена данными произошли ошибки, то будет выведено соответствующее сообщение. Подробный отчет об обмене данными с системой ЭДО можно посмотреть в журнале обмена.

>   Журнал обмена с системой ЭДО записывается в файл, имя которого указано в константе **_МАРКИРОВКАИМЯФАЙЛАЖУРНАЛА**. Если такой константы нет в системе, то по умолчанию используется имя файла **d:\\marking_http.log**
{.is-info}


## Загрузка файлов УПД в формате ФНС XML.

В случае, если на момент использования ПО Айтида в ней ещё нет профиля для обмена с нужной системой ЭДО, можно поступить следующим образом.

В системе ЭДО сохранить входящие УПД в файлах XML. Файлы будут в формате, регламентируемом ФНС для обмена УПД в электронном виде.

Затем, в модуле Маркировка необходимо перейти на закладку **Поставки**.

![](/images/marking/edi/f28650bbf301d5c8572ab6c2575a0791.png)

Нажать кнопку **Загрузить УПД из файла XML**. Будет предложено выбрать файл для загрузки.

![](/images/marking/edi/2b5316b3e3bc8337e2a2fd926a1e6195.png)

Загруженный из файла документ становится равноправным документом, для которого доступны проверка кодом маркировки и создание приходной накладной.

Вне зависимости от того, как был загружен документ в Айтиду, для него производятся следующие сопоставления.

1.  Ищется поставщик в справочнике контрагентов. Поиск осуществляется по в следующем порядке:
    -   по идентификатору поставщика в системе ЭДО (поле ЭДО ИД в карточке контрагента);
    -   по ИНН и КПП;
    -   по ИНН среди контрагентов без указанного КПП.
2.  Для каждой строки документа ищется товар в справочнике ТМЦ. Поиск осуществляется в следующем порядке:
    -   если в УПД был передан ШК товара, то ищется по нему;
    -   из полученного в коде маркировки GTIN извлекается EAN ШК и ищется по нему;
    -   в последнюю очередь ищется по названию товара в справочнике.

## Проверка принятых УПД.

Загруженные из системы ЭДО документы можно проверить на правильность принимаемых кодов маркировки. Для этого, необходимо дважды щелкнуть на нужном документе, или в контекстном меню выбрать пункт **Просмотр/корректировка поставки КМ**.

![](/images/marking/edi/daf6b36c035d6ec2da5df4f5e3294a85.png)

В открывшемся окне будет выведена информация из полученного УПД.

![](/images/marking/edi/7c97069965a4124327eaea5467deeab4.png)

В шапке документа можно проверить реквизиты поставщика, от которого получен документ. В многострочной части документа отображается список товаров.

В колонках **GTIN**, **Наименование из УПД**, **Количество, Цена, Сумма и** **Единица** будут выведены реквизиты принимаемого товара из УПД. В колонке **Количество** будет указано количество из накладной поставщика. В колонке **Фактическое количество** необходимо указать реально поступившее количество товара. В колонке **Количество марок** будет посчитано количество прочитанных кодов маркировки.

В форме Проверка документа доступно сопоставление загруженных из **УПД** товаров с товарами Айтиды. Если в колонках **Код** и **Наименование в Айтиде** значение не указано, то это значит, что сопоставление еще не было выполнено, и его необходимо выполнить в этой форме, до создания приходной накладной из документа. В колонках **Наименование из УПД** и **Наименование в Айтиде** отображаются наименования, соответственно, загруженные из **УПД** и из карточки сопоставленного товара в Айтиде. Наличие двух наименований облегчает поиск ошибок при сопоставлении товаров. При обнаружении ошибок в сопоставлении, можно нажать на кнопку ![](/images/marking/edi/cf533c5ca5943751da728f747652392c.png) в колонке **У**, что позволит разорвать ранее установленную связь и выполнить сопоставление заново.

В списке доступны сортировка и фильтрация данных, аналогично другим формам системы Айтиды.

Фактическое количество может быть указано одним из следующих способов:

-   введено в соответствующую ячейку списка;
-   последовательным чтением кодов маркировки всех принятых товаров (при чтении сканером ШК количество в соответствующей строке будет увеличиваться на 1);
-   загрузкой кодов маркировки из ТСД (кнопка **Загрузка данных из ТСД** ![](/images/marking/edi/fadc575a92ba4da538d19c3a41656ce2.png) ).

При чтении штриховых кодов сканером система действует следующим образом:

>   Марки с пачек и упаковок необходимо читать сканером непосредственно в форме проверки документа не открывая окно со списком марок. Это связано с тем, что все необходимые проверки производится непосредственно в самой форме.
{.is-warning}


1.  Если в списке есть прочитанный код маркировки, то к фактическому количеству этого товара будет добавлена 1.
2.  Если в списке есть прочитанный код маркировки и он является КМ упаковки, то к фактическому количеству этого товара будет добавлено количество товара из упаковки.

>   **Примечание.** Загруженный документ может содержать коды маркировки как конечных товаров, например, пачек, так и упаковок, например, блоков или, даже, коробок. Если для строки указаны коды маркировки упаковки, а в количестве указано количество самих товаров (пачек), то чтение ШК с упаковки будет приводить к увеличению фактического на количество единиц товара (пачек) в упаковке (блоке). Например, принимается 100 пачек сигарет. Поставщик передал 10 кодов маркировки блоков. Чтение ШК с блока будет приводить к увеличению фактического количества на 10 пачек. Так как в самом КМ нет указаний на кратность количества, то Айтида действует следующим образом. Считает количество пришедших в УПД кодов маркировки для строки товара, в нашем примере это 10. Делит общее количество товара (поле Количество, в нашем примере 100) на количество КМ. Целая часть от полученного значения добавляется к фактическому количеству товара.
{.is-info}


3.  Если товара с прочитанным кодом маркировки нет в списке, то будет выведено сообщение об этом.
4.  Если прочитан ШК не являющийся кодом маркировки, а в списке есть товар с таким же GTIN или ШК EAN-13, то будет выполнено позиционирование на найденной записи.
5.  Если прочитан ШК не являющийся кодом маркировки, а у текущей записи ещё нет сопоставления с карточкой товара, то будет выполнено такое сопоставление с товаром, определенным по прочитанному ШК.
6.  Если прочитан ШК не являющийся кодом маркировки, а у текущей записи ещё нет сопоставления с карточкой товара, и товара с прочитанным ШК нет в базе Айтиды, то будет создан новый товар и с ним будет связана текущая строка.

>   Обратите внимание. Если в форме проверки установлен признак **Создавать карточки для новой продукции**, то система не будет запрашивать подтверждение перед создание нового товара.
{.is-warning}


>   Создаваемая карточка товара будет содержать ШК равные GTIN продукции (если GTIN не начинается на 29), прочитанный и прочитанный сканером ШК, приведший к созданию карточки. Если был прочитан ШК упаковки (блока), то, в случае учета товара в пачках, необходимо будет перенести этот ШК в доп. единицы, для того, чтобы в будущем система корректно распознавала этот ШК.
{.is-info}


>   Новая карточка товара будет создана с основной единицей измерения из группы ресурсов, связанной с папкой, выбранной в настройке модуля Маркировка. Если такой группы нет или в ней не указана единица измерения, то будет использована единица из строки УПД. Если в дальнейшем подразумевается учет этого товара в иных единицах, то необходимо единицу из УПД перенести в доп. единицы с соответствующим коэффициентом, а в качестве основной выбрать необходимую. Так нужно сделать для корректного создания приходных накладных на основании загруженных УПД.
{.is-info}


7.  Если прочитан ШК не являющийся кодом маркировки, а у текущей записи уже есть сопоставление с товаров из справочника, но прочитанный ШК не является ШК товара из текущей строки, то будет осуществлен поиск прочитанного ШК в остальном списке и позиционирование на найденной записи.

В списке товаров применяется цветовая индикация:

-   зелёный – строки, в которых количество по накладной совпадает с фактическим количеством;
-   голубой – строки, в которых количество по накладной больше фактического количества;
-   розовый – строки, в которых количество по накладной меньше фактического количества.

    В поле **Тип акта для отправки** нужно выбрать тип акта, который будет отправлен поставщику. Возможно только полное подтверждение или полный отказ от поставки. В случае отказа от поставки необходимо указать причину отказа, заполнив поле **Комментарий к акту**.

    Если необходимо для всей накладной проставить фактическое количество равным количеству от поставщика, т. е. полностью подтвердить накладную, то можно нажать на кнопку **Полностью подтвердить накладную**.

![](/images/marking/edi/2fa85b64c3407332d1ee10be01e78409.png)

Для полного отказа от накладной надо нажать кнопку **Полностью отказать от накладной**.

![](/images/marking/edi/f186e5adca370e86501564221b2d3fd7.png)

Нажатие на кнопку **Записать** приведёт к записи изменений. Если в списке остались не сопоставленные записи и установлен признак «Создавать карточки для новой продукции», то в момент сохранения будут созданы и автоматически сопоставлены недостающие товары. Нажатие на кнопку **Отмена** приведёт к отмене изменений.

В кнопке **Действия** предусмотрены следующие варианты:

1.  **Удалить все прочитанные марки из документа**. Позволяет удалить из документа все марки и начать их чтение заново.
2.  **Скрипт проверки перед разрывом связи между товаров и GTIN.** В режиме настройки позволяет задать скрипт, который будет выполняться в момент разрыва связи между товаров и **GTIN**. Так же вызывается при проверке перед сохранением документа. В скрипт передаются следующие переменные:
-   `ОПЕРАЦИЯ` – принимает значение CHECK при разрыве связи и SAVE при проверке перед сохранением изменений;
-   `КОДОБЪЕКТА` – принимает значение MRK;
-   `ИДОБЪЕКТА` – ИД принимаемого документа (из таблицы `mark_in`);
-   `ИДСТРОКИ` – принимает значение ИД строки документа (из таблицы `mark_in_spec`) при разрыве связи и 0 при проверке перед сохранением.
-   `ТОВАР` – принимает значение внутреннего кода товара при разрыве связи и пустое значение при проверке перед сохранением;
-   `GTIN` – принимает значение GTIN товара при разрыве связи и пустое значение при проверке перед сохранением.
1.  **Скрипт расчета фактического количества при чтении КМ.** В режиме настройки позволяет задать расчет на сколько будет увеличиваться фактическое количество, при чтении КМ упаковки.
-   `КОДОБЪЕКТА` – принимает значение MRK;
-   `ИДОБЪЕКТА` – ИД принимаемого документа (из таблицы `mark_in`);
-   `ИДСТРОКИ` – ИД строки документа (из таблицы `mark_in_spec`), для которой производится расчет;
-   `ТОВАР` – внутренний код товара из строки документа;
-   `GTIN` – GTIN товара из строки документа;
-   `КОЛИЧЕСТВО` – Количество из документа из текущей строки;
-   `ФАКТКОЛИЧЕСТВО` – текущее значение из колонки фактическое количество;
-   `КОДМАРКИРОВКИ` – прочитанный код маркировки;
-   `ИМЯТАБЛИЦЫ` – имя временной таблицы, со списком кодов маркировки текущей строки. Таблица содержит два поля mark (код маркировки) и kolp (уже заполненной количество для кода маркировки).

## Подтверждение УПД в системе ЭДО.

После проверки документа и выбора варианта акта – подтверждение или отказ от приемки – необходимо отправить эту информацию в систему ЭДО. Для этого необходимо отметить документ в списке и нажать кнопку отправки в ЭДО:

![](/images/marking/edi/07cf74d0c0dc54c7529237303eeae16c.png)

При успешной отправке маркер в колонке С будет зеленым. Одновременно с отправкой акта, в систему ЭДО отправляются и подписываются все служебные уведомления, которые предусмотрены регламентом ЭДО. Подпись документов осуществляется выбранным в параметрах модуля Маркировка сертификатом. Отправка актов возможна только для документов, загруженных из системы ЭДО. Если документ был загружен их файла, то отправить акт необходимо из интерфейса самой системы ЭДО.

## Создание приходной накладной из УПД.

После завершения всех процедур по подтверждению документа необходимо создать приходную накладную. Для этого необходимо отметить документ в списке и выбрать пункт контекстного меню **Создать приходную накладную**.

![](/images/marking/edi/95824400fd8645d40c6aa17564dbc412.png)

Внимание! В созданную накладную будут перенесены только сопоставленные с товарами из справочника ТМЦ строки УПД.

>   Если поставщик прислал данные в единицах измерения, отличных от учетных единиц измерения, то во время формирования приходной накладной будет произведен расчет коэффициентов, для корректной постановки на учет в Айтиде принимаемой продукции. Присланная единица измерения сначала ищется в доп. единицах карточки товара. Если там нет нужной доп. единицы, то такая единица и коэффициенты пересчета ищутся доп. единицах группы ресурсов, выбранной в карточке товара.
{.is-info}


# Отгрузка УПД в систему ЭДО.

Функционал доступен в конфигурациях Непродовольственная розница, Ресторан и Супермаркет. При возникновении необходимости вернуть маркированный товар поставщику или осуществить отгрузку маркированных товаров другому контрагенту необходимо создать расходную накладную с передаваемыми товарами. Для каждой строки прочитать коды маркировки. Указать цены и количество передаваемого товара. Записать и провести расходную накладную.

После успешной записи и проведения документа необходимо выбрать пункт **Выгрузка в ГИС Маркировка** кнопки **Работа с оборудованием**. ![](/images/marking/edi/fa6d11d27ffec39979654067e21b8eb4.png).

По фирме отправителю Айтида определит подходящее предприятие в модуле Маркировка и для него создается документ на закладке **Отгрузка**.

![](/images/marking/edi/bac7690b935e0789e363524e259c0d43.png)

Для отправки документа в систему ЭДО необходимо его отметить и нажать **Отправить отмеченные документы в систему ЭДО.**

![](/images/marking/edi/91661415214caaa648ff6dd582f2f0c2.png)

При успешной отправке будет выведено сообщение об успешной отправке документов:

![](/images/marking/edi/40a28f6efff4c7add7b7a043dac25ba6.png)

Через некоторое время после успешной отправки необходимо нажать кнопку проверки статусов отправки:

![](/images/marking/edi/0a0dbfc2c51438172e3a125b1c6ec576.png)

Сначала статус должен стать желтым, т. е. система ЭДО приняла документ:

![](/images/marking/edi/90fb8d6232261cb1a047e54dfe665a0b.png)

После подтверждения или отказа от документа получателем статус изменится на зеленый или серый:

![](/images/marking/edi/c02cb602e560508110fc106aa195fb4a.png)

![](/images/marking/edi/00970973e28f561e644e2ccec7b74b3e.png)

В случае, если расходная накладная проведена и получатель подтвердил документ, то запись убирается из списка.

В случае возникновения ошибок на каком-либо этапе статус документа будет красный, а в графе **Описание** будет указана причина ошибки. Просмотреть обмен служебными сообщениями можно выбрав пункт Документооборот контекстного меню списка.

![](/images/marking/edi/31cbe76a2c6ddbd724a3dc85d1b5a88f.png)

![](/images/marking/edi/f4ad491ecb36a957b236dbb8698f05a7.png)
