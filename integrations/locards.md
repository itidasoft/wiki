---
title: Айтида и система лояльности LoCards
description: Руководство по интеграции с системой LoCard
published: true
date: 2025-03-24T13:20:52.359Z
tags: скидки, бонусы, locards, лояльность
editor: markdown
dateCreated: 2022-12-21T10:26:30.552Z
---

# Введение

Данное руководство содержит описание процесса интеграции с сервисом управления клиентской лояльностью LoCards. Сервис LoCards предназначен для внедрения электронных карт лояльности с возможностью гибкой настройки дизайна карт и настройкой системы лояльности (скидки, бонусы, уведомления и прочее).

Интеграцию можно производить по двум вариантам:

\- «Полная интеграция» - встраивание в дисконтный модуль работы с картами и бонусами,

\- «Частичная интеграция» - работа с системой через незарегистрированные карты.

Ниже в таблице представлены основные отличия между двумя методами интеграции.

| **Функционал**                                                                                             | **Полная интеграция**                                                                                                                                                                           | **Частичная интеграция**                                                                                                              |
|------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| Добавление карт в чек по номеру телефона                                                                   | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                                                                                      | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                            |
| Возможность работы с картами клиентов без необходимости ручного заведения анкет клиентов в учетную систему | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                                                                                      | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                            |
| Добавление карт в чек по ФИО клиента                                                                       | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                                                                                      | ![Закрыть со сплошной заливкой](/images/integrations/locards/b31e84b6bc19f7a77f658bde3b5e1b54.png =100x100){.align-center}                                                           |
| Добавление карт в чек путем считывания штрихкода карты сканером                                            | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                                                                                      | ![Закрыть со сплошной заливкой](/images/integrations/locards/b31e84b6bc19f7a77f658bde3b5e1b54.png =100x100){.align-center}                                                           |
| Отражение и фиксация суммы бонусов, использованной в чеке продажи                                          | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                                                                                      | ![Закрыть со сплошной заливкой](/images/integrations/locards/b31e84b6bc19f7a77f658bde3b5e1b54.png =100x100){.align-center} (введенная сумма бонусов применяется как суммовая скидка) |
| Возможность автоматически загрузить сумму бонусов, потраченную при продаже, в чеке возврата                | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                                                                                      | ![Закрыть со сплошной заливкой](/images/integrations/locards/b31e84b6bc19f7a77f658bde3b5e1b54.png =100x100){.align-center}                                                           |
| Моментальный доступ к операциям по карте после самостоятельной регистрации карты покупателем               | ![Закрыть со сплошной заливкой](/images/integrations/locards/b31e84b6bc19f7a77f658bde3b5e1b54.png =100x100){.align-center} ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center} (должен пройти процесс обмена с LoCards) | ![Флажок со сплошной заливкой](/images/integrations/locards/a6f75ab8daa9a4f0c0ad43ac4219532c.png =100x100){.align-center}                                                            |

В данном руководстве будет рассмотрен только вариант «Полной интеграции».

# Настройка интеграции

>   Для работы с картами LoCards требуется обновить Айтиду до версии не ниже, чем 4.4.6.
{.is-warning}


Дополнительно после обновления потребуется скачать комплект интеграции с нашего сайта по ссылке: <https://itida.ru/dokumentatsiya/dopolnitelnye-materialy>.

>   Все первоначальные настройки потребуется производить в режиме расширенного конфигурирования, для которого потребуется наличие NFR лицензии у компании партнёра и генерации файла сублицензии для входа в режим.
{.is-info}


## Настройка констант

Для интеграции с личным кабинетом LoCards по API требуется использовать токен интеграции. Токен вы можете получить у вашего менеджера.

Полученный токен необходимо записать в константу с именем \_LOCARDS_TOKEN в справочнике констант системы (Сервис – Настройка системы – Настройка констант системы).

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/5bf7f97ad56881e4d07264a8c3d46269.png)

Некоторые запросы в систему LoCards требуют отдельной авторизации по логину и паролю. Для этого требуется создать две константы: \_LOCARDS_ЛОГИН и \_LOCARDS_ПАРОЛЬ. В качестве значений этих констант требуется указать логин и пароль от личного кабинета LoCards.

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/0ef791916b311f11b3aafee92518ea0d.png)

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/06110963fdd2f933417e6ff36f356cf4.png)

После записи констант необходимо перезапустить программу и приступить к дальнейшим настройкам программы.

## Настройка бонусного счетчика

Интеграция LoCards с дисконтным модулем Айтида в части работы с бонусными баллами происходит через справочник бонусных счетчиков. Вызов справочника счетчиков бонусов осуществляется через модуль Айтида Эксперт, входящий во все варианты поставок.

![](/images/integrations/locards/45fd62100d7c68256ae8e61db123f48d.png)

После перехода в справочник бонусных счетчиков требуется создать новый бонусный счетчик по шаблону, как указано на скриншоте ниже:

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/cba7e63ba5336eb53423d282e6faf5bc.png)

**Наименование:** указывается произвольное наименование бонусного счетчика (например: «LoCards бонусы»).

**Текст для чека:** здесь указывается наименование шаблона в системе LoCards, к которому требуется привязать бонусные карты. Шаблон с таким названием должен быть создан в системе LoCards. Пример связывания бонусных карт с шаблоном в LoCards представлен на скриншоте ниже:

![](/images/integrations/locards/8e8563d11d771e397f6a891674160665.png)

**Тип бонуса:** требуется указать название **LOCARDS** для связи счетчика с модулем интеграции. **Внимание! Указание иного типа бонуса приведет к неработоспособности интеграции.**

**Допустимо создание нескольких бонусных счетчиков для работы с LoCards, но для правильно интеграции счетчиков требуется во всех этих счетчиках указать одинаковый тип бонуса «LOCARDS».**

**Выражение для расчета суммы начисления:** Данный скрипт срабатывает при вводе карты для расчета суммы начисления, а также в момент отмены чека. По кнопке со звездой вызывается окно ввода скрипта, в котором требуется указать следующее выражение:

```js
RETURN RESTAPI.Locards_СкриптНачисления( НОМЕРКАРТЫ );
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/bbf08721eecf9de42b6685374007e030.png)

**Выражение для расчета максимальной суммы оплаты:** Скрипт вызывается для расчета максимальной суммы оплаты бонусами в чеке. По кнопке со звездой вызывается окно ввода скрипта, в котором требуется указать следующее выражение:

```js
// Для продажи возвращается минимальная из двух сумм: сумма остатка бонусов или процент от суммы чека, заданный в переменной МаксимальныйПроцентОплатыБонусами
// Для возврата сумма бонусов, бывших в оплате возвращаемого чека
МаксимальныйПроцентОплатыБонусами = 100; //процент от суммы чека, который можно оплатить бонусами. По умолчанию 100%
IF ( _ОПЕРАЦИЯ != "ВОЗВРАТ" AND _ОПЕРАЦИЯ != "ВОЗВРАТПРИХОДА" )
{
	СуммаБонусовПоКарте = RESTAPI.Locards_КоличествоБонусов( НОМЕРКАРТЫ, "", false );
	RETURN MIN( СуммаЧека * МаксимальныйПроцентОплатыБонусами / 100, СуммаБонусовПоКарте);
}
RETURN ЗАПРОС( "SELECT bonus FROM chequelist WHERE rid = '" + _ИДВОЗВРАЩАЕМОГОЧЕКА + "'" );
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/19563ac62984f5e18e816099ec8eedf2.png)

**Не записывать баллы автоматически:** необходимо установить данный флаг, для активации возможности работы с внешними счётчиками (бонусными системами). При активации данного флага станет доступно указание **Скрипта расчета**, в котором нужно указать следующий скрипт:

```js
RETURN RESTAPI.Locards_СкриптРасчета( НОМЕРКАРТЫ, "", true);
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/bf19438dca8be0aee1c12534183acb3f.png)

**Использовать по умолчанию для дисконтных карт:** Флаг необходимо установить в случае, если для всех новых карт необходимо автоматически привязывать данный бонусный счетчик. Если будут использоваться только бонусные карты, то флаг должен быть установлен.

## Привязка бонусного счетчика к картам

Для привязки созданного бонусного счетчика к имеющимся в базе картам нужно перейти в справочник дисконтных карт, отметить необходимые папки карт или карты галочкой и вызвать окно установки общих реквизитов на панели инструментов.

**![](/images/integrations/locards/a3056850c9fe388518dec78f34ccd90b.png)**

В открывшемся окне установки параметров выбрать счетчик бонусных баллов и нажать на кнопку «Выполнить».

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/b880595e67ab960e7a0e48d52e519d10.png)

В итоге во всех отмеченные карточках карт и карт в выделенных папках будет привязан бонусный счетчик.

## Настройка скидок для скидочных карт.

Если в системе LoCards предполагается использование не только бонусных, но и скидочных карт, то необходимо создать скидку в модуле Айтида: Эксперт.

![](/images/integrations/locards/88ab67852a4b87dc81949e1a5e956477.png)

В справочнике скидок нужно создать папку для скидок с нужным вариантом объединения скидок в чеке (в случае нескольких скидок).

![](/images/integrations/locards/b1706589db4443b39b699745bb627bdf.png)

В созданной папке необходимо создать скидку по шаблону ниже:

**Наименование:** произвольное наименование скидки

**Текст для чека:** название шаблона карт в личном кабинете LoCards для связывания карт со скидкой с нужным шаблоном (см пример для бонусных карт в [Настройка бонусного счетчика](#настройка-бонусного-счетчика)).

**Назначение:** на чек

**Тип:** автоматическая

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/27b50f7cded45a1e586644cc11d4cc42.png)

**Значение:** необходимо вставить следующий скрипт расчета значения скидки:

```js
RETURN ПЕРЕМЕННАЯ("LOCARDS_РАЗМЕРСКИДКИПОКАРТЕ", 0);
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/d2c908fd3cac7869a056d745a3ce4281.png)

**Тип значения:** -% (минус процент)

**Состояние карты:** Введена

## Привязка скидки к картам

Привязка скидок к картам осуществляется аналогично привязке бонусных счетчиков к картам (см. [п.2.3.](#привязка-бонусного-счетчика-к-картам)), за исключением того, что в окне установки реквизитов нужно выбрать скидку вместо счетчика:

![](/images/integrations/locards/d86939d1a06e3494eda57943c170088c.png)

## Настройка РМК для работы с картами.

Для применения функционала работы со скидками LoCards, а также для отправки информации о продаже с применением бонусов по карте в систему LoCards требуется произвести дополнительные настройки в схемах РМК (Справочник схем РМК).

В нужных схемах необходимо зайти на закладку «ЕГАИС и скрипты» и прописать следующие скрипты:

**Создание нового чека:**

```js
PUBLIC LOCARDS_РАЗМЕРСКИДКИПОКАРТЕ;
LOCARDS_РАЗМЕРСКИДКИПОКАРТЕ = 0;
```

![](/images/integrations/locards/bb55a48fe82f364c0f2dc6ee268fe1a4.png)

**Пост обработка чека:**

```js
IF ( _ОПЕРАЦИЯ != "ВОЗВРАТ" AND _ОПЕРАЦИЯ != "ВОЗВРАТПРИХОДА" )
	RESTAPI.LOCARDS_СовершениеПокупки( ИДЧЕКА, НОМЕРКАРТЫ, ВСЕГОБОНУСОВ );
ELSE
	RESTAPI.LOCARDS_УдалениеПокупки( ИДЧЕКА, _ИДЧЕКАОСНОВАНИЯ, НОМЕРКАРТЫ, true );
		
RETURN true;
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/479e308b4e96af2a4b072d7a4bddda28.png)

**Проверка значений и прав доступа:**

```js
LOCARDS_РАЗМЕРСКИДКИПОКАРТЕ = RESTAPI.СкриптПроверкиРазмераСкидкиПоКарте( _ИМЯПОЛЯ, _ЗНАЧЕНИЕПОЛЯ, true );
RETURN true;
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/ec94f11fd9cb24382bd6759ff6db1b9c.png)

Далее необходимо сохранить карточку схемы РМК и перейти к импорту/экспорту карт, если требуется.

## Настройка РМК для разделения продаж по магазинам

Для разделения операций и подключений по магазинам требуется создать карточку оборудования для работы с LoCards по следующему шаблону:

![locards_equipment.png](/images/integrations/locards/locards_equipment.png){.align-center}

**Тип оборудования**: указать "Прочее оборудование"
**Профиль**: выбрать профиль с названием "Профиль LoCards"

Сохранить карточку оборудования и добавить в схеме РМК в список оборудования для используемых рабочих мест.

![locards_eqlist.png](/images/integrations/locards/locards_eqlist.png){.align-center}

В параметрах РМК перейти к настройке оборудования, выбрать карточку оборудования для LoCards и перейти к настройкам оборудования.

![rmk_locards.png](/images/integrations/locards/rmk_locards.png){.align-center}

В открывшемся окне ввода параметров LoCards ввести ключ API и данные магазина.

![locards_params.png](/images/integrations/locards/locards_params.png){.align-center}

После сохранения параметров все операции по чекам будут отправляться в LoCards с указанием введенных данных по магазину.

## Выгрузка карт в LoCards

>   Внимание! Перед выгрузкой карт требуется создать и настроить шаблоны карт в личном кабинете LoCards и связать имена шаблонов с полями «Текст для чека» в карточке бонусного счетчика или карточке скидки.
{.is-warning}


Для выгрузки имеющейся базы карт и клиентов в LoCards необходимо воспользоваться профилем экспорта, входящего в комплект интеграции. Профиль экспорта необходимо загрузить в справочник импорта/экспорта (Сервис – Настройка импорта/экспорта данных).

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/62d24f0a7bcf041f1450f60a9fa8e984.png)

![](/images/integrations/locards/0a7104988e2731ebff37bff73cc1e29e.png)

*Импорт профиля обмена*

![Изображение выглядит как стол Автоматически созданное описание](/images/integrations/locards/88872b2f72e79f19b629ed4b88ee9ba2.png)

*Профиль обмена*

Так же необходимо загрузить параметры для профиля экспорта в справочник параметров системы (Сервис – Настройка системы – Настройка параметров системы).

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/4966ad60a3795fb2a7f42c9485ef043b.png)

![](/images/integrations/locards/293bc0791be65a3f002aa6f76871b917.png)

*Импорт параметров*

Загруженный профиль для быстрого доступа можно добавить в меню пользователя, либо на панель инструментов.

При запуске профиля доступен лишь один параметр для выбора, который регулирует производимый процесс: выгрузку карт в LoCards или загрузка карт из LoCards

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/c98f37859661b060c734310a9d2c5ae7.png)

Для выгрузки карт необходимо выбрать вариант «Выгрузка».

При этом в систему LoCards выгружаются карты, соответствующие следующим критериям:

-   Привязан клиент в карте или карта привязана к клиенту.
-   Клиент не помечен на удаление
-   У клиента заполнены фамилия и имя (в наименовании через пробел). Наименование клиента выгружается по следующему шаблону: «ФИО» (сначала фамилия, затем имя, далее отчество). Указание отчества является опциональным.
-   У клиента заполнен номер телефона
-   Количество символов в номере телефона в диапазоне от 11 до 12, включая знак «+», если используется.

>   Имеющиеся в системе LoCards карты не перезаписываются картами из Айтида, во избежание потери бонусных баллов. Выгружаются только новые карты
{.is-info}


## Загрузка карт из LoCards

Для работы с системой LoCards в режиме полной интеграции (см [«введение»](#_Введение)) необходимо наличие карт и клиентов в базе Айтида. Учитывая тот факт, что клиенты могут регистрироваться самостоятельно, такие карты нужно тоже загружать в Айтиду из LoCards. Для загрузки карт необходимо воспользоваться тем же профилем обмена, что и в разделе [выгрузка карт в LoCards](#выгрузка-карт-в-locards).

При вызове профиля обмена нужно выбрать вариант «Загрузка» и нажать «Продолжить»

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/cc6441fc0b5b7b5b904dba1778120d3b.png)
> 
>   В Айтиду загружаются только новые карты из системы LoCards. Имеющиеся в Айтиде карты не перезаписываются.
{.is-info}


## Автоматизация процесса обмена картами с системой LoCards

Для автоматизации процесса обмена картами с системой LoCards можно создать задание планировщика (Сервис – Планировщик задач) по следующему шаблону:

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/4849ef0bb54d287e043c1f3a11ae7fa8.png)

**Наименование:** произвольное наименование задания. Например: «Обмен картами с LoCards»

**Начать работу:** произвольная дата и время, с которой необходимо приступить к выполнению задания (если нужно отложить старт задания относительно даты настройки интеграции)

**Задание активно:** установить флаг, для активации задания.

**Периодичность запуска** и **Интервал запуска** задания: установить требуемую периодичность выполнения. Например, как на скриншоте: ежедневно, каждые 2 минуты.

**Текст обработки:** необходимо вставить следующий скрипт:

```js
КодШаблона = ЗАПРОС( "SELECT MAX(code) FROM sprimpex WHERE name ='Обмен картами с системой LoCards через RESTAPI'" );
IF ( ПУСТО( КодШаблона ) ) 
{
	СООБЩЕНИЕ( "Не найден шаблон экспорта Обмен картами с системой LoCards через RESTAPI" );
	RETURN;
}
LOCARDS_ВариантОбмена = "002"; //загрузка
ВЫГРУЗИТЬДАННЫЕ( КодШаблона );

LOCARDS_ВариантОбмена = "001"; //выгрузка
ВЫГРУЗИТЬДАННЫЕ( КодШаблона );
```

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/f1bddaea81c1fabfb7a78134d821ca56.png)

После вставки текста необходимо сохранить карточку задания и настроить службу Айтида для выполнения задач планировщика согласно руководству администратора.

# Работа с картами в Айтида РМК

## Работа с бонусными картами

При добавлении карты в Айтида РМК в чек по клиенту, по номеру карты вручную, по номеру карты сканированием штрихкода карты или при визуальном выборе из списка будет выводиться сообщение с информацией о карте следующего вида:

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/91a35e57e2eea1b6d4f330a31bccbde1.png)

Для бонусных карт будет доступно списание бонусных баллов при оплате чека, при их наличии.

![](/images/integrations/locards/1bde52352d792b90e018a32560f19933.png)

После пробития кассового чека в систему LoCards будет отправлена информация о совершении покупки и о потраченных при покупке бонусах.

![](/images/integrations/locards/3dc2c8d6d20fc166beb542322e778e79.png)

При пробитии чека на возврат на кассе на основании чека продажи, в котором была задействована бонусная карта и списаны бонусы, будет доступно указание суммы бонусов из чека продажи для их возврата на карту.

![](/images/integrations/locards/28d4161027170351613adb07bec748f1.png)

>   Внимание! Если сумма чека возврата, совпадает с суммой чека продажи, т. е. производится полный возврат, то в систему LoCards будет отправлена операция отмены покупки и все бонусы вернутся к состоянию до чека продажи. При частичном возврате операция отмены не посылается и требуется вручную в личном кабинете отрегулировать количество бонусов для начисления и списания по карте из чека.
{.is-warning}


![](/images/integrations/locards/e9e5dbfcfc4f66b0daec1c353e85e314.png)

## Работа со скидочными картами

При добавлении скидочной карты в чек будет выводиться сообщение с информацией о карте следующего вида:

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/dba72d14864f6319b93e89c0aa75854c.png)

При этом в чеке будет сразу применена скидка, указанная в поле «Скидка по карте».

После пробития кассового чека информация о совершении покупки так же будет отправлена в кабинет LoCards

![Изображение выглядит как текст Автоматически созданное описание](/images/integrations/locards/45d3420e1d0ee85dbef3ff0c10803ee2.png)
