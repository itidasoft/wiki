---
title: Работа модуля регистрации продаж версии 2
description: Айтида РМК
published: true
date: 2025-03-20T14:10:26.491Z
tags: запуск, авторизация, добавление позиции, оплата, печать чека, ввод карты, бонусы, сертификаты
editor: markdown
dateCreated: 2022-08-14T21:57:19.471Z
---

Запуск модуля осуществляется из ярлыка, описанного ранее. Если модулю удалось подключиться к базе данных и проверить лицензию, то будет выведено окно авторизации.

# Авторизация.

![](/images/rmk/working/2ac81a12e8eded3b820e030cfb90b922.png)

В поле уникальный пароль необходимо ввести пароль, указанный в карточке сотрудника.

![](/images/rmk/working/17057340e6ff395cdff119b9cbe02ed6.png)

Поиск авторизовавшегося сотрудника производится из списка, определенного для данного рабочего места. Если подходящего сотрудника не найдено, то будет выведено сообщение, что не найден подходящий пользователь. Если в схеме РМК список кассиров не заполнен, то поиск будет произведен среди всех сотрудников.

![](/images/rmk/working/5d5da694432c893997e56a58e9c788d8.png)

После успешной авторизации будет открыто основное окно модуля.

![](/images/rmk/working/e278cd8cec3a5a7c513473b7cf6b85e5.png)

В центральной части окна расположен список с товарами, подобранными в чек. В верхней левой части – информация о товаре из текущей строки списка.

В верхней правой части блок органов управления для подбора товара по наименованию, коду, артикулу или ШК.

В правой центральной части матрица товаров для быстрого подбора часто продаваемых товаров.

В нижней правой части блок кнопок для выполнения дополнительных функций и цифровая клавиатура.

В нижней части расположен информационный блок, содержащий итоги по чеку, имя ФР, текущую дату и время, имя авторизовавшегося кассира, выбранного клиента и его карта, тип создаваемого по чеку документа, название выбранного контрагента и имя менеджера.

В верхней части окна посередине расположена кнопка отображения экранной клавиатуры.

# Подбор товара.

Наиболее часто используемая функция интерфейса пользователя – это подбор товара в чек. Подбор может производиться несколькими способами.

## Подбор товара чтением ШК.

Наиболее простой способ подбора товара – это чтение штриховой код сканером. В случае, если прочитанному коду соответствует один товар, то этот товар сразу будет добавлен в список чека. Если одному ШК соответствует несколько товарных позиций, то будет выведено окно для уточнения выбора.

![](/images/rmk/working/d0b0e142e9d20d06b5309dbb6e31e9b1.png)

Для подтверждения выбора достаточно щелкнуть / дотронуться до нужной строки в списке.

## Подбор товара в строке поиска.

Если на товаре нет штрихового кода, либо штриховой код не читается, то в поле поиска можно ввести код, артикул, часть названия или штриховой код товара и нажать на кнопку **Поиска.** В случае нахождения подходящего элемента в справочнике товаров, товар будет добавлен в список. Если введенным условиям соответствует несколько товаров, то будет предложен уточняющий выбор.

## Подбор товара в визуальном поиске.

Визуальный поиск товаров позволяет найти нужный товар в иерархической структуре справочника, среди множества похожих вариантов. Для вызова данного метода необходимо нажать кнопку **Виз. Поиск**. В ответ на нажатие будет отображено окно со справочником товаров для выполнения поиска по нему.

![](/images/rmk/working/b72d65bb1de0e36a84ba6c49ab7ba1d4.png)

В окне поиска есть инструменты для перемещения по папкам справочника и для ввода уточняющих условий поиска. В этом окне выбор подтверждается нажатием на кнопку **Выбрать**.

Так же доступна сортировка списка по любой колонке. Для этого необходимо щелкнуть по заголовку колонки левой кнопкой мыши, либо применить клавиатурную функцию **Сортировать список**.

Для перемещения по папкам может быть использована клавиатура. Клавиша **Enter** или **CTRL-Down** позволяет «войти» в папку. Enter будет срабатывать если поле поиска пустое, а **CTRL-Down** всегда.

Слева в нижней части два переключателя, позволяющие отобразить дерево папок справочника и изменить параметры фильтрации справочника.

> *Обратите внимание. При подборе товара проверяется соответствие номера ФР, указанного в группе ресурсов товара и номеров ФР, доступных с схеме РМК. Если в группе ресурсов указан номер ФР, то в схеме РМК для рабочего места должен быть ФР с таким же номером. Иначе, товар не будет добавлен в чек.*
{.is-info}

### «Горячие» клавиши

| **Комбинация клавиш**                 | **Комментарий**                                                                                            |
|---------------------------------------|------------------------------------------------------------------------------------------------------------|
| <kbd>F3</kbd>                         | Если поле поиска пустое, то перейти в поле поиска. Если в поле поиска что-то введено, то произвести поиск. |
| <kbd>Ctrl</kbd>+<kbd>F3</kbd>         | Изменение переключателя **Искать в текущей папке.**                                                        |
| <kbd>Return</kbd> / <kbd>Enter</kbd>  | При нахождении текущей строки на папке, вход в папку. Иначе - подбор товара.                               |
| <kbd>Ctrl</kbd>+<kbd>Return</kbd>/<kbd>Ctrl</kbd>+<kbd>Enter</kbd> | При нахождении текущей строки на товаре – подбор товара.                      |
| <kbd>F4</kbd>                         | Изменение состояния переключателя дерева папок.                                                            |
| <kbd>F5</kbd>                         | Переход в дерево. Перемещение клавишами Up/Down будет производиться в дереве, а не в списке.               |
| <kbd>F6</kbd>                         | Перейти в список. Перемещение клавишами Up/Down будет производиться в списке.                              |
| <kbd>F7</kbd>                         | Очистка поля поиска, снятие фильтра со справочника и переход в поле поиска для ввода нового текста.        |
| <kbd>Up</kbd> / <kbd>Down</kbd>       | Перемещение по списку вверх / вниз.                                                                        |
| <kbd>Ctrl</kbd>+<kbd>Up</kbd>, <kbd>Backspace</kbd> | Перемещение на уровень вверх (выход из текущей папки).                                       |
| <kbd>PageUp</kbd>/<kbd>PageDown</kbd> | Перемещение по списку по страницам.                                                                        |
| <kbd>Ctrl</kbd>+<kbd>Home</kbd>/<kbd>Ctrl</kbd>+<kbd>End</kbd> | Перемещение в начало / конец списка.                                              |
| Буквы, цифры и прочие печатные знаки. | Переход в поле поиска для ввода текста.                                                                    |

# Продажа по свободной цене.

Если в схеме РМК разрешено производить продажу по свободной цене, то в панели **Скидки** будет доступна кнопка **Свободная продажа**.

![](/images/rmk/working/c5f5fd7758efbc8c656b36b256c3c20a.png)

Нажатие на кнопку позволит ввести реквизиты, для добавления в чек строки без товара, но с названием, ценой, количеством и единицей измерения.

![](/images/rmk/working/a9ec061bc8cd9884494af26d426c5aab.png)

Поля **Название** и **Единица** сохраняются и требуют постоянного заполнения. В случае использования несенсорного варианта интерфейса вызов функции можно назначить на клавишу клавиатуры. В таком случае запрос параметров будет выведен в отдельном окне. На свободную продажу будут распространяться скидки и округления на чек.

# Изменение цены и количества товара.

## Изменение количества товара в строке.

После выбора товара любым способом в списке указывается его количество равным единице. Для не маркированного товара количество может быть изменено на любое другое значение следующими способами:

-   при помощи клавиатуры;
-   при помощи экранной клавиатуры;
-   используя кнопки ![](/images/rmk/working/5e4506b582f171ef868273cc9d05fd61.png) и ![](/images/rmk/working/c4dd5b61280a4b6581cf56dbb842f24d.png) для уменьшения и увеличения количества;
-   выбрав в контекстном меню пункт изменения количества.

Кнопка ![](/images/rmk/working/fe3cd163a46518afc4dbdbcb81005cb2.png) позволяет отказать от ошибочного изменения количества.

Кнопка ![](/images/rmk/working/7228648146133165de800eda6dae0b60.png) позволяет удалить текущую строку из чека.

Кнопка ![](/images/rmk/working/0d9f557a782550482709624c4c9e1737.png) подтверждает внесенные изменения.

Так же, в блоке информации о товаре можно оперативно изменить единицу измерения, в которой продается товар. Например, если товар может продаваться целыми упаковками и частями, например блистерами, как лекарства, то в карточке товара можно задать дополнительную единицу измерения с необходимым коэффициентом. Тогда. в блоке информации о товаре будет активно оба переключателя ![](/images/rmk/working/f04b9f9b18bf4d2c2d91de433e58d8b1.png). Выбор между ними будет менять количество и цену в строке чека, в соответствии с коэффициентом пересчета цены и количества.

## Изменение цены.

По умолчанию при подборе товара на него устанавливается цена равная учетной цене. Цена может быть изменена двумя способами:

-   применением скидки на позицию;
-   вводом цены вручную из панели **Сервис**;
-   вводом цены вручную из контекстного меню строки чека.

Если в карточке оборудования разрешено изменять цену, т. е. вводить ее вручную,

![](/images/rmk/working/ef7029f0c7119e78c3454cdbce8f367f.png)

то в МРП v.2 будет доступна ручная корректировка цены.

![](/images/rmk/working/d054b8893a3a094ea28a8c9a27fe2d09.png)

![](/images/rmk/working/89dd95396c3c3976d39ba0304b5cc261.png)

При нажатии этой кнопки или выборе пункта меню будет предложено ввести новую цену на товар в текущей строке чека.

![](/images/rmk/working/a4c459c31094a853d581f191521a6839.png)

# Просмотр картинок товара.

Если в карточке товара с товаром связаны файлы изображений, то в МРП v.2 эти изображения выводятся в панели быстрого ввода товаров и в блоке текущего товара. Если с товаром связана одна и более картинок, то доступна функция просмотра увеличенных изображений товара.

Увеличенные изображения выводятся при нажатии левой кнопкой мыши на картинке в блоке текущего товара, при вызове контекстного меню строки чека и при активации клавиатурной функции **Картинки товара**.

![](/images/rmk/working/d3de1a5123300a1a992694a5cb49a5d7.png)

![](/images/rmk/working/bf36746356c38b6c1445c7143ccd0490.png)

Результат:

![](/images/rmk/working/8a0cfcb31720507f1306a0148a9d8761.png)

Нажатие клавиши ESC или щелчок мыши на картинке закроет просмотр.

# Подвал чека

В нижней части окна программы может быть отображено до пяти строк с общей информацией о формируемом чеке

![](/images/rmk/working/b622395e959278c1bac8b2e1e0a4e31d.png)

В первой сверху строке выводятся:

1.  Выполняемая операция.
2.  Номер чека. Выводится следующий номер чека для первого ФР в списке доступных для РМ.
3.  Остаток товара из текущей строки чека. Остаток считается по правилам, выбранным в параметрах РМК.
4.  Итоговая сумма к регистрации, предъявляемая к оплате покупателю.

При щелчке мыши на поле с типом выполняемой операции или номере чека будет предложен выбор операции:

![](/images/rmk/working/48066325a9f2c294f3cdf072e1a93786.png)

Вторая строка:

1.  Название ФР, на котором будет распечатан чек.
2.  Текущая дата и время.
3.  Имя авторизовавшегося кассира.
4.  Итоговая скидка в сумме и процентах.

Третья строка:

1.  Клиент владелец карты, выбранный в чеке.
2.  Номер дисконтной карты, выбранной в чеке.

При щелчке мыши на поле **Покупатель** или его названии будет предложено выбрать его из справочника.

При щелчке мыши на поле **Карта** и её номере или его названии будет предложено выбрать её из справочника.

Четвертая строка:

1.  Тип документа;
2.  Комментарий или контрагента. Если введен комментарий к чеку, то выводится комментарий. Если комментарий не был введен, а в параметрах чека был выбран контрагент, то будет выведено название контрагента.
3.  Ответственный менеджера.

При щелчке мыши на поле Тип документа будет предложено выбрать тип формируемого документа:

![](/images/rmk/working/bcd3ae7eff7239e5c64b76c71333fa15.png)

При щелчке мыши в остальных полях строки будет предложено ввести комментарий или выбрать ответственного менеджера за чек.

В пятой строке чека могут быть выведены дополнительные свойства чека, если такие были определены в схеме РМК. При щелчке мыши в пятой строке будет предложено ввести значения дополнительных свойств чека.

# Скидки

В МРП v.2 реализованы те же самые алгоритмы по работе со скидками, как и первой версии модуля. Поддерживаются следующие виды скидок:

-   ручные скидки на позицию, в том числе с выбором процента/суммы из диапазона;
-   ручные скидки на чек, в том числе с выбором процента/суммы из диапазона;
-   автоматически скидки по дисконтным картам;
-   автоматические скидки из схем скидок;
-   автоматически применяемые скидки на чек и позицию с произвольными расчетами.

## Примеры скидок.

### Скидка «за час до закрытия».

Позволяет организовать снижение цены приготовляемой продукции к концу дня.

![](/images/rmk/working/90d47471afb5d858320f4e3b1a7753ec.png)

```js
RETURN ЕСЛИ( _ВРЕМЯЗАКРЫТИЯ_ЧАС - ЧАС( ДАТАВРЕМЯ( ) ) <= 1, 30, 0 );
```

Выражение проверяет параметр времени работы предприятия и, если до закрытия осталось менее часа, то скидка составляет 30%. Иначе 0% (нет скидки).

### Скидка на товар при сумме чека более N рублей.

![](/images/rmk/working/c4ac4bb392b7b4ec8d296933683f39e1.png)

```js
// Если сумма чека в учетных ценах превысила 1300 рублей, то добавляем 
// определенный товар и делаем его бесплатным
IF ( СУММАЧЕКА >= 1300 )
{
	Сервис.РМКИнформацияОТоваре( "44550" );
	IF ( КОЛИЧЕСТВОТОВАРОВ == 0 ) 
	{
		IF ( СООБЩЕНИЕ( "Добавить акционный товар в чек?", "Акционный товар", 4 ) != 6 ) RETURN 0;
		Сервис.РМКДобавитьТоварВЧек( АкционныйТовар );
	}
	RETURN Сервис.РМКУчетнаяЦенаТовара( АкционныйТовар );
}
RETURN 0;
```

Скидка имеет признак **Автоматически применять скидку в форме регистрации продаж**. Это означает, что скидка в чеке есть всегда. Такая скидка должна в своем выражении анализировать необходимость своего применения. В данном случае, проверяется сумма товаров в чеке. Если она превышает указанный порог, то в чек добавляется бесплатный товар и на чек дается скидка в размере цены этого товара.

### Скидка 10% по карте на товар из Распродажи.

![](/images/rmk/working/6cd866f35497c2d6c2c4b22769683e24.png)

```js
//******ПЕРЕМЕННЫЕ*********
_ИМЯГРУППЫРАСПРОДАЖИ 	= "РАСПРОДАЖА";
_ПРОЦЕНТСКИДКИПОКАРТЕ 	= 10;
_СУММАПРОДАЖИ 			= cena * kolp;
//****КОНЕЦ ПЕРЕМЕННЫХ*****

_СУММАСКИДКИРАСЧЕТНАЯ = _СУММАПРОДАЖИ * _ПРОЦЕНТСКИДКИПОКАРТЕ / 100;
ГруппаТовара = ЗАПРОС("SELECT name FROM sprres_g WHERE code = (SELECT nngroup_stat FROM sprres WHERE code = '" + @Товар + "')");
IF ( ATC( UPPER(ГруппаТовара), _ИМЯГРУППЫРАСПРОДАЖИ) > 0 )
{
	ЦенаОпт = ЗАПРОС("SELECT dbo.fn_calcclev_cena('" + @Товар + "', GETDATE() , '001', '001') ");
	IF ( ЦенаОпт == 0 )
	{
		СООБЩЕНИЕ("значение скидки 1 = " + _СУММАСКИДКИРАСЧЕТНАЯ);
		RETURN 0;
	}
	
	_СУММАСКИДКИРАСЧЕТНАЯ = _СУММАПРОДАЖИ - kolp * ЦенаОпт;
}
СООБЩЕНИЕ("значение скидки 2 = " + _СУММАСКИДКИРАСЧЕТНАЯ);

RETURN _СУММАСКИДКИРАСЧЕТНАЯ;
```

Расчетная скидка на товар из группы товаров Распродажа, применяемая при предъявлении дисконтной карты. Скидка может быть указана в самой карте, либо скидка и карта участвуют в одной схеме скидок.

## Ручные скидки.

МРП v.2 поддерживает возможность выбора кассиром ручной скидки на позицию или на чек. Для того, чтобы функционал был доступен, в карточке оборудования должны быть разрешены ручные скидки. Если дополнительно указано, что ручные скидки разрешены только Администратору, то МРП v.2 проверит профиль пользователя. В случае, если профиль не 29/30, то ручные скидки будут запрещены.

![](/images/rmk/working/90e57eb358027a93184632c552796649.png)

Скидка может быть выбрана в блоке **Скидки / Скидка на чек** или **Скидка на позицию**.

![](/images/rmk/working/c614903603a13e7638e6c45c2cfc90c3.png) Если скидка подразумевает ввод значения кассиром, т. е. в описании скидки указан диапазон значений, то будет предложено ввести значение скидки из диапазона.

![](/images/rmk/working/63c78a5b30ce8cf6aacb9d3d3bbfe482.png)

![](/images/rmk/working/c3a863dc9424b447ed5ee797a3f86b8d.png)

## Дисконтные карты и клиенты.

Дисконтная карта клиента может быть прочитана сканером ШК, при этом ШК карты не должен пересекаться с ШК товаров. Так же номер дисконтной карты можно ввести в поле поиска и нажать кнопку **Скидки/Карта клиента**. При этом МРП v.2 произведет поиск карты по номеру. Если карта будет найдена, то она будет применена. Будут рассчитаны указанные в карте скидки и обработаны объекты скидок, содержащие этот номер карты. Если карта не будет найдена, то скидки применяться не будут, но номер карты будет зафиксирован в чеке.

Если при покупателе при себе нет самой карты или есть сомнения в номере карты, то можно воспользоваться визуальным поиском в справочнике дисконтных карт. Для этого поле поиска необходимо оставить пустым и нажать кнопку **Карта клиента**. Будет выведено окно для визуального поиска карты. Аналогично можно осуществить поиск клиента владельца карты.

![](/images/rmk/working/2b1e3c9486aec3ad78f3654ed09c9018.png)

При выборе клиента будет использована связанная с ним дисконтная карта. Нажатие кнопки Информация о карте позволит просмотреть обороты по карте.

![](/images/rmk/working/12bad09f6d27788bedfd42d1c0255d4b.png)

Если карта была введена ошибочно, то ее можно удалить из чека нажав кнопку **Убрать карту/клиента**.

# Сервис

В блоке Сервис предусмотрены необходимые операции при работе с МРП v.2. А именно:

-   отмена документ;
-   возврат по документу;
-   работа с отложенными документами;
-   выбор операции для документа – продажа, возврат, приход, возврат прихода, прочее;
-   выбор менеджера;
-   печать копии чека;
-   закрытие смены.

![](/images/rmk/working/aedbe424a93469589f903400628a7e64.png)

## Отменить документ.

При нажатии на кнопку **Отменить документ** все строки, скидки и прочее из чека будут удалено. Будет создан новый пустой чек. Если в чеке были строки, то перед отменой будет запрошено подтверждение пользователя.

## Чек на основании

При необходимости выполнить возврат по ранее пробитому чеку, закрытие аванса или оплату кредита необходимо нажать на кнопку **Чек на основании**. При этом будет предложено выбрать чек, на основании которого формируется новый чек.

![](/images/rmk/working/72fa5385721211d8991147e805fd47ca.png)

В полях **Устройство, № чека** и **Дата** можно задать условия для поиска нужного чека. Если поле дата будет пустым, то будут показаны чеки за все даты, удовлетворяющие другим условиям.

Кнопка **Печать** позволяет распечатать копию выбранного чека.

Признак **Чеки всех РМК** добавит в список чеки всех РМК из базы.

После выбора чека система определит, какая операция больше подходит для нового чека. Оценка производится по следующим критериям:

1.  Если выбранный чек полностью оплачен и отгружен, то будет предложено создать возврат по этому чеку.
2.  Если выбранный чек полностью оплачен, но это был чек покупки от поставщика, то будет предложено выполнить возврат поставщику.
3.  Если выбранный чек является чеком продажи в кредит, то будет предложено выполнить оплату кредита (тип чека Оплата/Аванс).
4.  Если выбранный чек является чеком покупки в кредит, то будет предложено выполнить оплату поставщику (тип чека Оплата/Предоплата поставщику).
5.  Если выбранный чек является чеком аванса, то будет предложено выполнить его отгрузку.
6.  Если выбранный чек является чеком предоплаты поставщику, то будет предложено выполнить поставку.

В случае, если выбрана операция, связанная с отгрузкой, приемом или возвратом товара, то содержимое выбранного чека будет загружено в текущую регистрацию. Так же кассир сможет увидеть, на основании каких чеков он выписывает новый.

![](/images/rmk/working/5aa5dfee7b21c65d90312d65c18ffc2e.png)

## Выбор операции по чеку.

В МРП v.2 Предусмотрено 7 видов чеков:

-   продажа;
-   возврат продажи;
-   приход;
-   возврат прихода;
-   прочее/вскрытие тары;
-   оплата/аванс;
-   предоплата поставщику.

Список доступных операций может быть настроен в схеме РМК. Выбор нужной операции выполняется последовательным нажатием на желтую кнопку с названием операции. Если на кнопке написано **Возврат**, то нажатие на нее приведет к выбору операции **Возврат продажи**. При этом название кнопки изменится на следующую доступную операцию. Таким образом второе нажатие выберет следующую операцию, после возврата.

## Выбор менеджера.

МРП v.2 позволяет для каждого чека выбрать ответственного менеджера, информация о котором будет записана в транзакции. Это даст возможность формировать отчеты о продажах в разрезе ответственных менеджеров. Подбор менеджера производится способом аналогичным другим подборам. Если в строке поиска введена часть имени ли кода, то будет предложено выбрать из списка подходящих сотрудников. Если ничего не введено, то будет открыт визуальный поиск сотрудника из справочника.

## Отложенные документы (пречеки).

МРП v.2 позволяет отложить (сохранить) начатый чек и продолжить работу с новым чеком. Для этого необходимо нажать на кнопку **Отложить документ**. Потом, можно будет вернуться к отложенному документу нажав на кнопку **Загрузить отложенный**. Если был всего один отложенный чек, то он и будет загружен. Если таких чеков несколько, то будет предложено выбрать один из списка.

![](/images/rmk/working/523158eb5e1633876041b0b4caeb7a7f.png)

## Печать копии чека.

Позволяет выбрать чек и распечатать его копию.

## Закрытие смены.

В конце рабочего дня необходимо закрыть смену. Для этого в разделе Сервис необходимо нажать кнопку **Закрыть смену**. Нажатие этой кнопки запишет транзакцию о закрытии смены и выполнит обработку **Формирование z-отчета** из профиля оборудования.

Если в профиле РМК настроено создание документов, то в процессе закрытия смены будет выполнено формирование всех необходимых документов.

![](/images/rmk/working/6034e8a3fdc93fbca459ad0ca61ba2ea.png)

При создании документов используются следующие правила, определяющие основные параметры документа:

1.  Склад определяется в следующем порядке:
    1.  если в схеме РМК указано, что склад определяется из группы ресурсов товара, то склад берется из группы ресурсов товара;
    2.  иначе, или если в группе ресурсов не задан склад, то значение берется из карточки торгового оборудования ФР, на котором был пробит чек;
    3.  иначе, если у ФР не указан склад, значение берется из записанного в чеке. По умолчанию, в чеке указывается первый склад из поля **«Склады остатков»** схемы РМК;
    4.  иначе, если в схеме РМК не заданы склады остатков, то значение берется из поля **«Склад для определения цены»** схемы РМК.
2.  Код организации определяется в следующем порядке:
    1.  если в схеме РМК указано, что организация определяется из группы ресурсов товара, то значение берется из группы ресурсов товара;
    2.  иначе, или если в группе ресурсов не задана организация, то значение берется из чека. По умолчанию, в чеке указывается значение из карточки оборудования ФР, на котором пробивается чек;

Документы автоматически делятся по складам, организациям и другим признакам, указанным в схеме РМК.

Если рабочих мест кассира несколько, то можно воспользоваться автоматическим созданием документов после закрытия смены. В этом случае не будет тратиться время кассира, на ожидание создания документов, а документы будут создаваться автоматически службой Айтиды.

Для настройки автоматического создания документов необходимо выполнить следующие действия.

1.  В схеме РМК изменить скрипт создания документов на следующий: <br>
    ![](/images/rmk/working/5d8b4a7479616626549eb109cd580a45.png)
		<br>
    Этот скрипт создаст «флаг» в параметрах системы, говорящую заданию планировщика о том, что по РМК необходимо создать документы.

```js
ЗАПРОС( "DELETE FROM param WHERE param = 'RMKREADYCODE' AND value = '" + _РМККОД + "';
	 INSERT INTO param ( param, value ) VALUES ( 'RMKREADYCODE', '" + _РМККОД + "' )" );
```

2.  Создать задание для планировщика, как на рисунке <br>
    ![](/images/rmk/working/166c0190ed165b73af0eecffad43ea24.png)
		<br>
    Задание с указанным интервалом будет проверять наличие «флага». При обнаружении, удалит флаг и сформирует документы.

```js
ДОБАВИТЬКОНТЕКСТ( "SELECT value FROM param WHERE param = 'RMKREADYCODE'", "СписокРМК" );
ПОКА ( !КОНЕЦКОНТЕКСТА( "СписокРМК" ) )
{
	IF ( Сервис.РМКСоздатьДокументы( "0000000001", СЖАТЬПРОБЕЛЫ( СписокРМК.value ) ) )
		ЗАПРОС( "DELETE FROM param WHERE param = 'RMKREADYCODE' AND value = '" + СписокРМК.value + "'" );
	ПРОПУСТИТЬ( 1, "СписокРМК" );
}
УДАЛИТЬКОНТЕКСТ( "СписокРМК" );
```

> *Код 0000000001 необходимо заменить на код схемы РМК.*
{.is-info}


3.  Настроить службу Айтиды на обработку заданий планировщика.

## Открытие смены.

В начале рабочего дня необходимо открыть смену. Для этого в разделе Сервис необходимо нажать кнопку **Открыть смену**. Нажатие этой кнопки запишет транзакцию об открытии смены и выполнит обработку **Открытие смены** из профиля оборудования.

## Печать копии чека.

Нажатие кнопки позволяет выбрать из списка сформированный ранее чек и напечатать его копию. Для печати копии чека будет вызвана обработка **Печать прочих отчетов** из профиля. Обработке будет передан код отчета 100 и номер чека для печати. Так же, будет запущена печатная форма заданная для копии чека в схеме РМК.

## Параметры

Раздел Параметры доступен только Администратору. В этом разделе можно выбрать схему РМК, сам РМК и настроить сканер штриховых кодов и задать другие параметры.

![](/images/rmk/working/ca8823af3e3a99f9115c88a272db07b5.png)

### Раздел Настройки рабочего места.

**Схема РМК** – задает принадлежность рабочего места к определенной схеме. Значение определяет, из какой схемы РМК будут браться все настройки.

**РМК** – задает конкретное РМК из выбранной схемы. По этому значению будут делиться чеки в базе данных.

**Узел обмена** – Задает код узла обмена, в котором работает РМК. Если задан узел обмена, то это говорит системе о том, что используется распределенная база данных (см. раздел Распределенная база данных.)

**Сервер** – Задает код узла обмена сервера, с которым необходимо производить обмен данными. Если значение в поле выбрано, то в момент закрытия смены программа будет связываться со службой Айтиды и ждать окончания отправки данных в центр.

**Дополнительные настройки обмена** – Нажатие кнопки позволяет указать даты и время последней передачи данных. Бывает необходимо передать не только текущие продажи, но и повторить выгрузку более ранних данных.

**Масштаб** – задает коэффициент увеличения (\> 100%) или уменьшения (\< 100%) элементов интерфейса программы. Настройка предназначена для подбора оптимального зрительного восприятия элементов интерфейса на конкретном мониторе. Доступные значения – от 50% до 300%. Для мониторов большого размера, но с низким разрешением можно выбрать меньшее значение масштаба. Для мониторов меньшего размера, но с большим разрешением – большее значение. Выбранное значение будет примерным, т. к. реальное значение будет подбираться таким образом, чтобы программные окна помещались целиком на экране монитора.

В случае, если в схеме РМК установлен параметр «Интерфейс для сенсорного экрана» в правой части главного окна программы будут выведены панели для доступа к различным функциям и товарам. Эти панели будут масштабироваться таким образом, чтобы на экране помещалась панель товаров целиком и, как минимум, одна строка панели функций. Это сделано для того, чтобы кнопка Оплата была всегда доступна без необходимости прокрутки экрана.

![](/images/rmk/working/b4bf1f5f6589f5fd4b026620a3fa4e0b.png)

**Использовать жесты** – рекомендуется включать данный параметр на сенсорных устройствах, на которых не используется мышь. В таком случае, прокрутка правых панелей, списка товаров и строк подвала чека будет производиться вверх-вниз и вправо-влево соответственно. Если используется мышь, то параметр лучше выключить, т. к. движение мышью с нажатой левой кнопкой будет восприниматься системой как жест. Для прокрутки панелей можно использовать колесо мыши.

### Раздел Настройки клавиатурного сканера

Параметры раздела позволяют настроить работу с клавиатурным сканером штриховых кодов.

**Чувствительность** – Позволяет задать «чувствительность» системы. Это означает, с каким интервалом система будет ожидать появления новых символов в буфере клавиатуры. Низкая чувствительность означает больший интервал. Высокая – меньший. Чем больше интервал, тем выше вероятность того, что ввод с клавиатуры будет воспринят как чтение ШК. Чем меньше интервал, тем больше вероятность того, что на длинных ШК сканер прервется и ШК будет разбит на два. В общем случае выбирается среднее значение.

**Префикс** – если у сканера настроен префикс, передаваемый в буфер клавиатуры перед самим ШК, то нужно его выбрать из предлагаемого списка. Наличие префикса у сканера упрощает работу системы и позволяет снизить вероятность ошибочных чтений ШК.

**Суффикс** – Если у сканера запрограммирован суффикс, передаваемый в буфер клавиатуры после чтения ШК, то необходимо его выбрать из списка. Наличие суффикса позволяет системе правильнее делить ШК при ошибочном быстром повторном чтении ШК сканером.

### Раздел Настройки COM сканера ШК.

Параметры раздела позволяют настроить работу МРП v.2 со сканером штриховых кодов, работающим через интерфейс RS232. Список параметров соответствует стандартным настройкам коммуникационного порта.

**Автоподключение** – Установка параметра укажет программе на необходимость повторного подключения к COM порту сканера ШК при инициализации каждого нового чека. Переподключение производится последовательным отключением от COM порта сканера, ожиданием 1 секунды и новым подключением к порту.

### Раздел Дисплей покупателя.

В разделе можно задать параметры для связи с программой Дисплей покупателя (см. раздел **Дисплей покупателя**).

### Раздел Прочие настройки.

В разделе можно выбрать код УТМ для оправки данных в ЕГАИС при продаже алкогольной маркированной продукции. Параметр **Остаток** позволяет указать программе, как рассчитывать остаток для отображения в подвале чека при подборе товара. Возможные варианты:

1.  **Без учета всех чеков**. Будет выводиться только учетный остаток, без учета текущих продаж.
2.  **Без учета отложенных чеков**. Будет выводиться остаток с учетом пробитых чеков, по которым не были ещё сформированы учетные документы, но без учета отложенных чеков.
3.  **С учетом отложенных чеков**. Будет выведет остаток с учетом всех чеков, по которым не были ещё сформированы учетные документы, в том числе, и с учетом отложенных чеков.


**Профиль сканера ШК**. В списке можно выбрать профиль для сканера ШК, что позволит настраивать нестандартные схемы обработки прочитанных штриховых кодов.

**Адрес iMark**. Если по какой-то причине в схеме РМК нельзя указать единый для всего узла адрес сервера **iMark**, то это можно сделать в поле **Адрес iMark**. Формат этого поля позволяет указать адрес и пароль для доступа кассы к серверу **iMark**. Пароль указывается через разделитель @ после адреса и порта сервера.

**Делить оплаты по ПС при делении чеков по ФР** – если параметр установлен, то при разделении одной регистрации на несколько чеков в ККТ оплата будет производится частями для каждого чека. Для оплаты будут выбираться платежные системы, связанные с ККТ, на которой был распечатан чек. Обычно, деление производится по организациям.

**Использовать жесты** – параметр предназначен для работы с сенсорным экраном и включает функционал скроллинга жестами.

**Предпросмотр отчетов** – при включенном параметре отчеты, предназначенные для вывода не windows принтер, например, ценники, не будут сразу отправляться на печать. А будут предварительно выведены на экран.

Обучающий режим – при включенном параметре чеки не будут отправляться на печать и в ОФД.

## Дополнительные функции.

При нажатии кнопки **ЕЩЕ…** будут доступны дополнительные сервисные функции:

![](/images/rmk/working/edfd676dfd3fe5a757b74db8f09af60f.png)

В верхней части списка постоянные пункты **Внесение** и **Выплата**.

Позволяет выполнить внесение и выплату суммы из кассы. При выборе любого из этих двух вариантов будет предложено ввести сумму. После чего, будет распечатан чек и операция будет записана в кассовые транзакции.

![](/images/rmk/working/29c85011f2428364fbb93f029041a756.png)

Выбор пункта **Завершение работы** закроет программу. При этом, если был открыт непустой чек, то будет предупреждение. Что данные будут потеряны. В нижней части списка отчеты, список которых задается в профиле в обработке **Список разрешенных отчетов**.

# Параметры чека.

В разделе **Параметры чека** можно выбрать контрагента, тип формируемого документа и варианты формирования чека.

![](/images/rmk/working/fc749c48b16248bc7bd21e92481c10bd.png)

Если для чека выбран документ расходная накладная, приходная накладные, возврат от покупателя, возврат поставщику, то можно подобрать контрагента, который будет указан в создаваемом документе. Для каждого контрагента будет создан отдельный документ.

Если установлен параметр **Формировать отдельный документ**, для чека будет создан отдельный документ, вне зависимости от других параметров формирования документов. Параметры **Печатать копию чека**, **Электронный чек** и **Чек коррекции** передаются в профиль и им обрабатываются.

Поле Комментарий к чеку позволяет просмотреть/задать комментарий, который будет сохранен вместе с чеком и отображен при выборе отложенного чека, чека возврата или чека для печати копии.

# Оплата и печать чека.

В блоке **Оплата** выводятся итоги чека и дается возможность выбрать, как оплатить чек. Для ввода значений доступны только те виды оплаты, которые разрешены пользователю в схеме РМК.

![](/images/rmk/working/f57afaf1b6f1650a05f583e0a18d0505.png)

После того, как значение в поле **Остаток** стало равным нулю, можно распечатать чек, нажав кнопку Печать. В случае успешной проверки всех введенных значений, чек будет сохранен в базе данных и будут выполнены обработки профиля оборудования, отвечающие за формирование и печать чека. После успешного завершения печати будет выполнена печать отчетной формы, если такая была определена в схеме РМК.

После успешного завершения всех действий будет открыт новый пустой чек.

# Система быстрых платежей.

Для использования системы быстрых платежей для приема оплаты от покупателей необходимо в справочнике оборудования создать карточку платежной системы и выбрать профиль **Система быстрых платежей**.

![](/images/rmk/working/d86f2b5f23b72d5be597350909701929.png)

Созданную карточку необходимо добавить в список оборудования РМ в схеме РМК.

![](/images/rmk/working/e3c99177dd43d6f61119476ab6428be7.png)

В момент оплаты покупателем необходимо ввести сумму, которая должна быть оплачена через СБП:

![](/images/rmk/working/ec7971ae8c10d811e598a438073c7ff6.png)

Перед печатью чека кассиру и покупателю (на дисплей покупателя) будет выведет QR код для оплаты через СБП.

![](/images/rmk/working/f84566affc920f1cb474aa3a7572cadb.png)

В случае успешной оплаты кассир должен подтвердить оплату. В этом случае чек будет считаться оплаченным этим видом оплаты. При отказе, будет отменена операция оплаты и чек вернется в исходное состояние.

# Незавершенные чеки.

Если в процессе оплаты, печати или отправки данных в ЕГАИС возникли проблемы, которые не удалось сразу решить, например, пропало электричество и компьютер рабочего места отключился, то вся регистрация переходит в состояние незавершенного чека.

Если перед аварией не было произведено оплаты, отправки данных в ЕГАИС, печати одного из под-чеков, то регистрация будет загружена полностью как новая, только с предупреждением, что это незавершенный чек.

![](/images/rmk/working/2aba3b24a30e7a3517cd008f869963ec.png)

Если какие-то действия были произведены, например, была осуществлена транзакция оплаты безналичным способом, то кассир увидит другое окно, в котором будет указано, какая оплата прошла без ошибок и чем предполагается оплатить чек. Внести изменения в эти данные уже нельзя, т. к. часть действий была выполнена ранее.

![](/images/rmk/working/5727a878c49149520cb272c9c4f4d8e8.png)

В этом окне кассир может, исправив проблему, продолжить **Печать чека**. Все ранее успешно произведенные операции, такие как:

1.  безналичные оплаты;
2.  успешно завершенная печать под-чека;
3.  отправка данных в ЕГАИС

будут пропущены.

Если кассир не может исправить проблему, то он может попытаться **Отменить чек**. При этом, будет произведена попытка отменить ранее успешно выполненные операции.

В случае возникновения проблемы и с отменой чека, кассир может отложить такой чек, чтобы позже решить возникшую проблему.

![](/images/rmk/working/85b6f0eb0db991b87ff6bc004de5d44f.png)

# Постоплата чеков.

Режим постоплаты включается в схеме РМ на закладке Прочее / Прочие параметры.

В режиме постоплаты чеки продажи сначала печатаются на ККТ и отправляются в ОФД, а после этого предлагается их оплатить. Оплата может быть отложена на неопределенное время.

В режиме постоплаты изменяется интерфейс программы. Вместо кнопки **Оплата** выводится кнопка **Печать чека**.

![](/images/rmk/working/72c28930695b2a30da5515b2b43ada32.png)

Окно и панель распределения оплаты не выводятся. Чек продажи печатается сразу. Для чеков, отличных от чека продажи при нажатии этой кнопки выводятся панель или окно оплаты чека. Таким образом, функционал действует только на продажи. Формируемы таким образом чеки продажи используются вид оплаты **Кредитом**, что позволяет осуществить их оплату позже.

После печати чека сразу предлагается его оплатить.

![](/images/rmk/working/a6fd5fc9dbd6eb6e632fc89054ba7991.png)

Оплатить чек можно сразу. Либо, нажать кнопку **Позже**. При нажатии кнопки **Позже**, чек будет отложен в специальное хранилище неоплаченных чеков. Доступ к списку неоплаченных чеков производится из панели **Сервис / Оплатить чек**.

![](/images/rmk/working/0623a57ff96e4a10b5c7b2820d3b661b.png)

При нажатии кнопки **Оплатить чек** будет предложено выбрать чек для оплаты и оплатить его

![](/images/rmk/working/9ae3110afc47aa9fcd77436d2163db1d.png)

В момент оплаты будет распечатан чек на оплату ранее выданного кредита по чеку продажи.

# Бонусная система.

Модуль регистрации продаж v.2 имеет встроенные механизмы для реализации различных бонусной схем. Основным элементом настройки бонусной системы является **Справочник счетчиков бонусных баллов**. Справочник доступен из окна **Айтида** **Эксперт**.

![](/images/rmk/working/b13ef181a55d41b7f9744e2b067ae078.png)

## Справочник счетчиков бонусных баллов.

![](/images/rmk/working/d56af75fd10f2f474853c406a991eb3f.png)

Справочник предназначен для описания правил начисления и списания бонусных баллов для карт клиентов. Для каждой карты клиента может быть указан счетчик баллов, который будет автоматически накапливать и списывать в оплату баллы.

![](/images/rmk/working/646a2faa5d948cdb65692c9bdaffc8c5.png)

Карточка счетчика содержит следующие поля:

1.  **Наименование** – отображается в полях выбора счетчика.
2.  **Текст для чека** – позволяет задать текст, который может быть напечатан в чеке (по умолчанию не печатается).
3.  **Тип бонуса** – значение, которое будет записано в таблицу учета накоплений / списаний. Позволяет объединять несколько счетчиков в единый учет накоплений/списаний. Например, при достижении определенного оборота по карте, к карте может быть привязан другой счетчик. При этом, все накопления/списания сохранятся. Смена счетчика на счетчик другого типа, позволит начать учетную историю заново.
4.  **Выражение для расчета начислений** – позволяет задать произвольное выражение, которое будет вычисляться и результат вычислений использоваться как количество начисляемых баллов по чеку. Расчет производится в момент формирования (печати) чека. Для выражения доступны все переменные, определенные на момент печати чека. По умолчанию, для новых счетчиков используется выражение, как на рисунке: <br>
    ![](/images/rmk/working/226d24b83a2690db01a036d6f760b1a5.png)

5.  **Начисление активируется через** – поле позволяет задать количество дней, через которое начисленные баллы будут доступны к списанию.
6.  **Начисление сгорят через** – поле позволяет ограничить срок действия начислений определенным количеством дней. Система списания баллов действует таким образом, что позволяет отслеживать срок действия начислений как при полном. Так и при частичном списаниях.
7.  **Выражение для расчета максимальной суммы списания** – выражение позволяет ограничить сумму списания на один чек. По умолчанию будет разрешено списать все накопленные баллы в пределах суммы чека. Выражение позволяет ограничить сумму определенным процентом от суммы чека.
8.  **Признак Не записывать баллы автоматически –** укажет системе, что не нужно автоматически записывать начисления и списания баллов. В таком случае, необходимо составить скрипт для обработки записи чека, который будет самостоятельно осуществлять запись начислений и списаний.
9.  **Признак Использовать по умолчанию для дисконтных карт –** признак может быть установлен только у одного счетчика. При его наличии у всех новых карт клиентов, добавляемых любым способом в систему, будет выбран именно этот счетчик.
10. **Признак Предлагать использовать скидку, вместо начислений –** установка признака укажет системе, что в окне ввода суммы баллов для оплаты чека необходимо вывести параметр **Не начислять бонусные баллы, а применить скидку на чек**. Установка параметра приведет к тому, что начисления не будет записаны, а на их сумму будет применена скидка на чек. <br>
    ![](/images/rmk/working/d8e6d1a4f5263d9058e66750c720c283.png)

## Управление начислениями и списаниями баллов.

Для обеспечения возможности вносить изменения в начисления и списания баллов предусмотрен механизм **Управление бонусными баллами**. Для работы с ним, в карточке карты клиента предусмотрена соответствующая кнопка.

![](/images/rmk/working/3c6c5835e33f2cb72f9fa860086e0f62.png)

![](/images/rmk/working/caf304e2909200a01bed0a10b9d9b0c1.png)

Форма позволяет добавлять, удалять и изменять начисления и списания баллов.

![](/images/rmk/working/627dead8711dcd7d58f69745dfcf7cee.png)

В случае, если изменяется или удаляется начисление, то система будет осуществлять контроль за тем, чтобы остаток баллов не стал отрицательным. Контроль осуществляется, как за конечным. Так и за промежуточными остатками.

## Настройка бонусной системы без счетчиков бонусных баллов.

В случае, если по каким-либо причинам использовать счетчики бонусных баллов затруднительно, можно настроить собственный учет начислений и списаний бонусных баллов. Для этого, в схеме РМК необходимо изменить скрипт **Проверка перед записью чека** добавив в него строки, которые будут записывать начисления и списания баллов в систему. Пример такого текста приведен ниже.

![](/images/rmk/working/7cecded0791d474c6920968c746f4624.png)

```js
// Если карта не введена, то никаких начислений, бонусов и скидок нет
IF ( КОЛИЧЕСТВОКАРТ <= 0 ) RETURN true;

НОМЕРКАРТЫ			= КАРТЫ[ 0 ];
// В зависимости от суммы начислений рассчитываем процент скидки
ПроцентСкидки		= ЗАПРОС( "SELECT CASE WHEN card_type = '1' THEN 1 ELSE 2 END AS proc_ FROM sprmcard WHERE cardn= '" + НОМЕРКАРТЫ + "'" );

// При возврате начисляем указанное количество бонусов
IF ( _ОПЕРАЦИЯ == "ВОЗВРАТ" )
{
ЗАПРОС( "EXEC sp_bonuscharge '" + STDF( НОМЕРКАРТЫ ) + "', 'БОНУС', " + STR( ВСЕГОБОНУСОВ, 16, 2 ) + ", " + ИДОБЪЕКТА );
}
ELSE			   
{			   
	ЗАПРОС( "EXEC sp_bonuscharge '" + STDF( НОМЕРКАРТЫ ) + "', 'БОНУС', " + STR( ПроцентСкидки * ( ВСЕГОНАЛ + ВСЕГОБЕЗНАЛ - ВСЕГОСДАЧА ) / 100, 16, 2 ) + ", " + ИДОБЪЕКТА );
	IF ( ROUND( ВСЕГОБОНУСОВ, 2 ) > 0 )
		ЗАПРОС( "EXEC sp_bonusspent '" + STDF( НОМЕРКАРТЫ ) + "', 'БОНУС', " + STR( ВСЕГОБОНУСОВ, 16, 2 ) + ", " + ИДОБЪЕКТА );
}
```

Для записи начислений рекомендуется использовать стандартную хранимую процедуру **sp_bonuscharge,** со следующим синтаксисом

```SQL
EXEC sp_bonuscharge ‘НомерКарты’, ‘ТипБонуса’, Сумма, ИДЧека, ‘ДатаОперации’, ‘ДатаАктивации’, ‘ДатаСгорания’
```

Параметры.

1.  **НомерКарты** – номер карты клиента. Учет баллов ведется в разрезе номеров карт.
2.  **ТипБонуса** – строка, тип бонусных баллов. Учет накоплений и списаний баллов ведется в разрезе типов бонусов.
3.  **Сумма** – сумма начисления, т. к. количество баллов, на которое увеличится остаток.
4.  **ДатаОперации** – дата проведения операции. Параметр не является обязательным. Если не указан, то датой операции будет являться дата и время текущего момента времени.
5.  **ДатаАктивации** – дата, когда накопление будет активировано. Параметр не является обязательным. Если не указан, то датой активации будет являться дата операции.
6.  **ДатаСгорания –** дата, когда накопление будет аннулировано. Параметр не является обязательным. Если не указан, то накопление будет бессрочным.

Для записи списаний так же рекомендуется использовать стандартную хранимую процедуру **sp_bonusspent,** со следующим синтаксисом

```SQL
EXEC sp_bonuspent ‘НомерКарты’, ‘ТипБонуса’, Сумма, ИДЧека, ‘ДатаОперации’
```

Параметры.

1.  **НомерКарты** – номер карты клиента. Учет баллов ведется в разрезе номеров карт.
2.  **ТипБонуса** – строка, тип бонусных баллов. Учет накоплений и списаний баллов ведется в разрезе типов бонусов.
3.  **Сумма** – сумма начисления, т. к. количество баллов, на которое увеличится остаток.
4.  **ДатаОперации** – дата проведения операции. Параметр не является обязательным. Если не указан, то датой операции будет являться дата и время текущего момента времени.

Процедура **sp_bonusspent** добавит запись о списании баллов на сумму не более чем текущий остаток.

## Работа с бонусной системой на кассе.

Работа кассира с бонусной системой сводится к вводу карты клиента, получению и анализ информации о начислениях, списаниях и текущем остатке бонусных баллов.

![](/images/rmk/working/701fc56d12d7c06f038f552fbc863fb0.png)

В момент проведения оплаты, кассир может применить в качестве оплаты накопленные бонусные баллы. Для этого, в окне расчета с покупателем необходимо нажать кнопку **БОНУС**. В верхнем поле **Бонус:** окна расчета с покупателем кассир может проконтролировать текущий остаток накопленных баллов для того, чтобы сразу информировать об их наличии покупателя.

![](/images/rmk/working/cea31dc9224e4da3e385ce6c5eacf199.png)

При нажатии кнопки **БОНУС** будет выведено окно для ввода суммы списания бонусных баллов. Система проконтролирует, чтобы кассир не ввел слишком большую сумму. Так же, в этом окне будет указано, сколько баллов будет начислено по чеку.

![](/images/rmk/working/59cdaddbc24e7d0813c69091f22838a8.png)

# Платёжные и подарочные карты.

Модуль регистрации продаж v.2 имеет встроенные механизмы для работы с платёжными и подарочными картами. Основным элементом настройки такой работы является **Справочник групп карт клиентов** и **Справочник карт клиентов**. Справочники доступны из окна **Айтида** **Эксперт**.

![](/images/rmk/working/e85efdda5f7a96eab8f09517427bc6ff.png)

## Справочник групп карт клиентов.

![](/images/rmk/working/8c347ba4c1ef6e4c8c4b2cd98c2afa2e.png)

Справочник предназначен для описания правил начисления и списания сумм с баланса платёжных и подарочных карт. Платёжные карты отличаются от подарочных тем, что у подарочной карты можно определить **Номинал**, в пределах которого принимать карту к оплате. **Платёжная карта** является пополняемой и для нее можно указать Кредитный лимит. Таким образом возможна настройка оплаты платёжной картой на сумму превышающую текущий баланс.

В группе карт клиентов можно задать общие для карт свойства.

![](/images/rmk/working/2e6795aa3575c55c218a7958abb29bf7.png)

-   Текст для чека;
-   Вид карты – дисконтная, подарочная, платёжная;
    -   Для дисконтной карты можно указать ставку скидки;
    -   Вид и счетчик для выгрузки во внешние фронт системы;
    -   Счетчик бонусов.
-   Скрипт проверки при вводе карты;
    -   Выполнение скрипта производится в момент чтения карты. Если при чтении ШК было определено, что это номер карты клиента, то вызывается данный скрипт, который должен вернуть **Истину**, если карта «правильная» и её необходимо обработать. Так же, скрипт вызывается при выборе карты из справочника и вводе номера в строку ввода. Для подарочной и платёжной карты скрипт должен определить действие, которое необходимо выполнить с картой - начисление на карту, или активировать подарочную карту (выполнить первое начисление номинала). Или списание суммы с баланса карты в оплату чека. Если необходимо начисление/активация карты, то скрипт должен установить значение переменной **ДОБАВЛЯТЬСТРОКУВЧЕК** в значение **ИСТИНА**. При этом, в чек будет добавлена строка с указанным в переменной **Товар** (внутренний код товара) или **КодТовара** (код в главной базе). Если товар не будет указан, то необходимо указать непустое значение переменной **ТЕКСТДЛЯЧЕКА**, который будет преобразован в свободную продажу, с указанной ценой из переменной **ЦЕНА** и **ЕДИНИЦЕЙИЗМЕРЕНИЯ**. Сумма начисления на баланс карты будет равна сумме, указанной в строке чека. Для списания сумм с баланса необходимо установить значение переменной **ДОБАВЛЯТЬСТРОКУВЧЕК** в значение **ЛОЖЬ** и вернуть из скрипта значение **ИСТИНА**.

        Дополнительные переменные передаваемые в скрипт.
        
| Название | Описание |
| --- | --- |
| ДОБАВЛЯТЬСТРОКУВЧЕК | Необходимо установить в **Истина**, если нужно выполнить начисление на баланс карты.                                                                                                           |
| ЗАПРОСИТЬСУММУ      | Если необходимо, чтобы была запрошена сумма пополнения карты, то необходимо установить значение переменной в **Истина**.                                                                       |
| ТОВАР               | При начислении баланса на карту можно указать внутренний код товара, который будет присутствовать в чеке под видом предоплаты за товары.                                                       |
| КОДТОВАРА           | При начислении баланса на карту можно указать код товара в главной базе, оставив переменную **ТОВАР** пустой. Это альтернативный вариант указания товара для строки чека.                      |
| СУММА               | При начислении баланса на карту можно указать сумму начисления, задав значение переменной **СУММА.** Если указан товар для строки чека, то сумма, равная цене товара может быть взята из него. |
| МАКСИМАЛЬНАЯСУММА   | При запросе суммы начисления можно ограничить ввод максимальной суммы начисления, указав значение переменной **МАКСИМАЛЬНАЯСУММА**.                                                            |
| МИНИМАЛЬНАЯСУММА    | При запросе суммы начисления можно ограничить ввод минимальной суммы начисления, указав значение переменной **МИНИМАЛЬНАЯСУММА**.                                                              |
| МАКСИМАЛЬНАЯСКИДКА  | Для того, чтобы скидки не применялись к добавленной строке чека можно указать значение переменной равным нулю.                                                                                 |
| ТЕКСТДЛЯЧЕКА        | Если не предусмотрено товара для добавления в чек при начислении на карту, то необходимо определить текст для чека, который будет использован в качестве «свободной продажи».                  |
| ЕДИНИЦАИЗМЕРЕНИЯ    | Код единицы измерения для «свободной продажи».                                                                                                                                                 |
| НОМЕРКАРТЫ          | Входящая переменная. Номер обрабатываемой карты.                                                                                                                                               |
| БАЛАНС              | Входящая переменная. Текущий баланс обрабатываемой карты.                                                                                                                                      |
| НОМИНАЛ             | Входящая переменная. Номинал обрабатываемой карты.                                                                                                                                             |
| КРЕДИТ              | Входящая переменная. Кредитное ограничение обрабатываемой карты.                                                                                                                               |
| ТИПКАРТЫ            | Входящая переменная. 1 – подарочная карта, 2 – платёжная карта.                                                                                                                                |

-   Скрипт расчета суммы оплаты – доступен для подарочной и платёжной карты;
    -   Выполнение скрипта производится несколько раз.
        -   1\. При подборе карты в чек;
        -   2\. Перед формированием чека;
        -   3\. При нажатии кнопки «Сертификат» в окне оплаты чека.

            Скрипт должен вернуть **Истину**, если рассчитал сумму, которую необходимо списать с баланса карты в оплату чека. Если в чеке несколько карт, то скрипты вызывается последовательно для каждой карты, в порядке подбора карт в чек. Для каждой карты в скрипт передается набор переменных, позволяющий упростить расчет необходимой суммы. Если скрипт вернет сумму превышающую сумму необходимую к оплате, то с баланса карты будет списана меньшая сумма, не превосходящая сумму, требуемую к оплате чека. Скрипт не будет вызван в случае, если сумма к оплате равна нулю. Если скрипт вернет 0, то с баланса карты не будет списываться никакая сумма.

            Дополнительные переменные передаваемые в скрипт.
            
| Название | Описание |
| --- | --- |
| СУММАКОПЛАТЕ    | Сумма, которую необходимо добавить к текущим оплатам чека, для полного его закрытия. При вызове скрипта для первой карты из списка равна сумме чека к оплате за минусом указанных сумм для наличной, безналичной, оплатой кредитом и бонусами. Для последующих карт данная сумма будет уменьшена на возращенные значения для предшествующих карт. |
| НОМЕРКАРТЫ      | Номер обрабатываемой карты.                                                                                                                                                                                                                                                                                                                       |
| НОМИНАЛ         | Номинал обрабатываемой карты.                                                                                                                                                                                                                                                                                                                     |
| КРЕДИТ          | Кредитное ограничение обрабатываемой карты.                                                                                                                                                                                                                                                                                                       |
| БАЛАНС          | Текущий баланс карты, без учета списаний в оплачиваемом чеке.                                                                                                                                                                                                                                                                                     |
| ТИПКАРТЫ        | 1 – подарочная карта, 2 – платёжная карта.                                                                                                                                                                                                                                                                                                        |
| ОПЛАТАСЕРТФИКАТ | Перед вызовом скрипта значение переменной равно нулю. Скрипт должен определить сумму оплаты, которая будет добавлена к типу оплаты **Сертификатом**.                                                                                                                                                                                              |
| ОПЛАТАКРЕДИТ    | Перед вызовом скрипта значение переменной равно нулю. Скрипт должен определить сумму оплаты, которая будет добавлена к типу оплаты **Кредит**.                                                                                                                                                                                                    |

-   Срок действия карт с выбранной группой.

## Справочник карт клиентов.

В справочнике карт клиентов задаются все виды карт клиентов, которые могут быть обработаны в МРП 2.

![](/images/rmk/working/0d5d7093735b3b2056d8fae176c8046c.png)

Реквизиты для подарочной или платёжной карты задаются на закладке **Подарочная / платёжная карта**.

![](/images/rmk/working/f0482298226282f4fc6b085369e94234.png)

В функции генерации дисконтных карт, так же можно выбрать группу карт, для того чтобы сгенерировать карты нужного типа. Параметры из группы карт будут перенесены в создаваемые карты клиентов.

![](/images/rmk/working/1e11bdb35b07feaf7dffa99456111f27.png)

## Применение подарочных и платёжных карт для оплаты чека.

Для применения подарочной или платёжной карты необходимо подобрать карту клиента любым удобным способом:

-   Прочитать сканером/ридером карт
-   Выбрать из справочника карт
-   Ввести номер карты в поле ввода и выполнить клавиатурную функцию подбора карты.

После подбора карты будет выполнен скрипт проверки номера карты из группы карт клиентов. Если скрипт вернет **Истину**, то будет выведено окно с информацией о карте вида:

![](/images/rmk/working/002c325145f37302d0dfb8e4a118626f.png)

Если баланс карты нулевой, т. е. оплатить ею ничего нельзя, а кредитного лимита нет, то скрипт должен вернуть указание на добавление строки в чек, для пополнения баланса карты. В случае подарочной карты сумма пополнения должна быть равна номиналу карты. В случае платёжной карты – кассир должен иметь возможность ввести сумму пополнения. Для этого скрипт может установить значение переменной **ЗАПРОСИТЬСУММУ** равным **Истина**.

Дальнейшая обработка подарочной и платёжной карт заключается в расчете допустимой суммы, которая может быть принята в оплату чека. Вызов скрипта расчета такой суммы производится при подборе карты и при нажатии кнопки оплаты сертификатом в окне оплаты чека. Так же, если в окне оплаты чека в момент нажатия кнопки **Печать** есть не нулевой остаток **Суммы к оплате**, и в чек подобраны платёжные или подарочные карты, то так же будет выполнен скрипт расчета, а остаток **Суммы к оплате** будет по возможности списан с платёжной/подарочной карты, а не переведен в наличную оплату.

В момент формирования чека будут записаны транзакции начисления и/или списания сумм с баланса карт.

# Разливные напитки с ФСМ (крепкий алкоголь).
Функционал предназначен для автоматизации процесса продажи разливных напитков маркированных ФСМ (крепкий алкоголь) без предварительного розлива в фасованную тару. Для разливного крепкого алкоголя предусмотрена отправка чека в ЕГАИС в формате версии, т.е. с указанием ФСМ и проданного объема. 
>  	Функционал доступен только в модуле регистрации продаж версии 2.
{.is-warning}

Функционал продажи разливного маркированного (крепкого) алкоголя предназначен для решения следующих задач:
 - Обеспечить соблюдение законодательства и позволить передавать в ЕГАИС каждый продаваемый объем алкоголя с указанием ФСМ.
 - Минимизировать трудозатраты персонала и снизить потенциал возникновения ошибок при продаже такого алкоголя. Основная трудность и возможность ошибок кроются в том, что один вид продаваемого алкоголя в ЕГАИС может быть представлен многими позициями. Например, одна водка может быть в бутылках разного объема, что в ЕГАИС означает разные позиции и алкокоды. Если при продаже каждой порции алкоголя требовать от кассира считывать ФСМ продаваемой продукции, то кроме высокой трудоемкости (необходимости делить проданный объем по остаткам бутылок), это неминуемо приведет к ошибкам, когда с одной ФСМ будет отправлен объем превышающий объем бутылки.

Поэтому, предлагаемый функционал предусматривает возможность продажи единого наименования товара с автоматическим определением ФСМ, объема и конкретной позиции ЕГАИС в момент формирования чека. Для реализации такого механизма расчета и списания объемов необходимо произвести подготовительную работу в справочнике товаров.
Для каждого вида продаваемого алкоголя создаются карточки товара с указанием названия, цены, вида продукции и признака разливного алкоголя. Указывается единица измерения **литр** или **миллилитр**. В дополнительных единицах измерения могут быть добавлены стандартные порции с указанием коэффициентов пересчета в выбранную базовую единицу. При наличии дополнительных единиц кассир сможет сразу выбрать требуемую порцию при продаже.

![vodka_req.png](/images/rmk/working/vodka_req.png){.align-center}

![vodka_units.png](/images/rmk/working/vodka_units.png){.align-center}

К созданной карточке разливного напитка подбираются входящие в нее позиции ЕГАИС. Для заполнения таких связей выбран существующий функционал Альтернативных замен. При продаже система будет искать вскрытые бутылки среди выбранного списка продукции. 

![vodka_alter.png](/images/rmk/working/vodka_alter.png){.align-center}

В схеме РМК необходимо включить работу с ЕГАИС и проверить выражение проверки принадлежности товара к алкоголю. При подборе в чек разливного крепкого алкоголя МРП v.2 не будет требовать чтения ФСМ, а проверит наличие вскрытой бутылки с необходимым остатком. 

В одной позиции чека можно продавать алкоголь из нескольких вскрытых бутылок. При этом, в ЕГАИС будет отправлен чек в версии формата 4 с разбивкой по ФСН и объемам, списываемых с каждой бутылки. Например, есть две вскрытые бутылки объемом 0.5 л и 0.25 л. В чеке может присутствовать строка с продажей 0.7 литра. В таком случае, бутылка 0.5 будет продана целиком (или в размере остатка в ней), а недостающее будет продано из второй бутылки 0.25. В печатной версии чека и при отправке в ЕГАИС будет отражена данная разбивка.

![alco_script.png](/images/rmk/working/alco_script.png){.align-center}

```js
RETURN ЗАПРОС( "SELECT dbo.fn_alcotype( nnvid ) FROM sprnn WHERE nn = '" + Товар + "'" );
```

## Настройка схемы РМК для работы с разливными напитками.

Для активации функционала работы с розливом продукции, в схеме РМК необходимо разрешить данную операцию либо для кассира, либо для администратора.

![rmk_scheme.png](/images/rmk/working/rmk_scheme.png){.align-center}

На закладке «ЕГАИС и скрипты» можно задать скрипт, который будет выполнять дополнительные проверки, при осуществлении операций розлива. 

![rmk_scheme_scripts.png](/images/rmk/working/rmk_scheme_scripts.png){.align-center}

В скрипт будут передаваться следующие параметры.

| Параметр | Возможные значения |
| --- | --- |
| МЕСТОВЫЗОВА | При создании группы кранов - ГРУППА;
| | При создании нового крана - КРАН; |
| | При установке на кран - УСТАНОВКАНАКРАН; |
| | При снятии с крана - СНЯТИЕСКРАНА; |
| | При розливе в тару - ТАРА; |
| | При отправке документа в МТ - МТОТПРАВКА |
| ИД | Идентификатор созданного объекта (группы, крана, кега, тары). Для отправки в МТ – идентификатор документа Выбытие КМ модуля Маркировка. |

Если скрипт реализован, то должен вернуть логическое значение Истина, если разрешена операция. Иначе Ложь. Если скрипт вернет Ложь, то операция будет отменена.

## Форма Вскрытие бутылок.

Перед началом работы с разливными напитками в МРП v.2 необходимо произвести настройку "Вскрытия тары ". Доступ к форме производится из раздела Сервис/Вскрытие тары.

![menu_opentare.png](/images/rmk/working/menu_opentare.png){.align-center}

При нажатии кнопку будет открыта форма Вскрытие тары. В ней необходимо добавить группы и для каждой группы заполнить их параметры. Группы необходимы для деления вскрытой тары между барменами. Доступ к управлению группами имеют сотрудники с правами администратора.

![form_opentare.png](/images/rmk/working/form_opentare.png){.align-center}

Группы объединяют в себе бутылки, вскрытие одним барменом. Деление служит только визуального разделения, чтобы не возникало случайных ошибок закрытия «чужих» бутылок. Так же, в группе задаются параметры, необходимые для отправки чеков в **ЕГАИС**.
Нажатие на кнопку **Добавить группу кранов** выведет окно для добавления группы

![tare_group.png](/images/rmk/working/tare_group.png){.align-center}

Название группы может быть произвольным до 250 символов. Организация и Склад будут реквизитами отправляемых в ЕГАИС чеков. В поле **УТМ** можно выбрать УТМ, в который будут отправляться чеки. Если в группе УТМ не выбран, то будет использован УТМ из параметров РМК.

Кнопка **Изменить описание группы** позволяет внести изменения во все поля группы.

При удалении группы все бутылки из группы будут перемещены в первую по порядку группу. В списке всегда должна быть хотя бы одна группа. Если в списке всего одна группа, то её нельзя будет удалить. 

![group_deletemessage.png](/images/rmk/working/group_deletemessage.png){.align-center}

### Вскрытие бутылки.
При нажатии кнопки **Вскрыть бутылку** будет предложено ввести описание вскрываемой бутылки.

![open_bottle.png](/images/rmk/working/open_bottle.png){.align-center}

В общем случае, бармену необходимо прочитать сканером или вставить в поле Маркировка код ФСМ. Система определит по ФСМ продукцию и её объем. Бармену необходимо будет проверить определенные параметры.

В случае необходимости можно задать комментарий, который будет выведен в списке вскрытых бутылок.

### Закрытие бутылки.
После того, как весь объем бутылки был продан, бутылку необходимо закрыть. Для этого необходимо выбрать строку с бутылкой и нажать на кнопку **Закрыть бутылку**.

![close_bottle.png](/images/rmk/working/close_bottle.png){.align-center}

Если на момент закрытия в бутылке остался не проданный напиток, то его можно будет списать. 

>  	Списанный объем нельзя будет продать. Поэтому, списывать нужно только не подлежащий продаже остаток напитка. Например, разлитые или утраченные иным способом.
{.is-warning}

В поле комментарий можно указать причину списания остатка. В случае, если остаток не был списан.

## Продажа разливных напитков.

При продаже кассир может подобрать продукцию любым предусмотренным в ПО способом. 

При подборе разливной продукции в чек будет предложено выбрать продаваемый объем. Выбор предоставляется из списка дополнительных единиц измерения карточки товара. Если в дополнительных единицах добавлена только один вариант продаваемого объема, то выбор этого объема осуществляется автоматически, без отображения на экране.

![unit_selection.png](/images/rmk/working/unit_selection.png){.align-center}

При выборе предопределенного объема тары будет считаться, что продается штучный товар указанного объема, т.е. в строке чека необходимо будет указывать целые значения продаваемого количества. В итоговом чеке и при списании будет произведен пересчет из выбранного объема тары в реально проданный объем продукции исходя из коэффициента в карточке товара. В случае выбора базовой единицы измерения, будет считаться, что продается свободный объем и в количестве нужно будет указать именно продаваемый объем, возможно дробный с точностью до трех знаков после запятой, напитка в учетных единицах измерения.

Если кассир ошибся с выбором продаваемой тары, то он может изменить выбор щелкнув на строке чека и выбрав пункт контекстного меню **Выбрать единицу**. Для кассира должно быть разрешено контекстное меню в схеме РМК.

![context_menu.png](/images/rmk/working/context_menu.png){.align-center}

В момент подбора товара в чек и / или изменения количества товара в строке чека производится проверка наличия необходимого объема напитка. В случае успешной проверки, в строке товара будет выведен зеленый маркер. ![green_marker.png](/images/rmk/working/green_marker.png)

Если проверка не пройдена, то будет выведено сообщение о нехватке объема к продаже, 

![no_bottles.png](/images/rmk/working/no_bottles.png){.align-center}

а в строке будет выведен красный маркер 

![red_marker.png](/images/rmk/working/red_marker.png){.align-center}

Данные маркеры являются только информацией для кассира о последней проверке наличия. В момент закрытия чека для всех строк будет произведено определение ФСМ и анализ возможности списания объема. Поэтому, в случае красного маркера есть возможность до закрытия чека открыть бутылку и добавить необходимый объем к продаже. В случае зеленого маркера, существует вероятность, что к моменту закрытия чека объем будет продан на другой кассе и его не хватит к продаже в текущем чеке.

## Отправка чека с разливной продукцией в ЕГАИС.

В ЕГАИС отправляется чек со товарами, соответствующими тем маркам, которые получились при распределении продаваемых объемов между вскрытыми бутылками. В чека формата 4 для ЕГАИС количество указывается в миллилитрах, поэтому, вся проданная разливная продукция будет пересчитана в литры, а затем в миллилитры.

Пересчет производится по следующим правилам.

1.  Если единица измерения, в которой был продан товар имеет прямой пересчет в литры (в справочнике единиц измерения) то сразу используется полученный коэффициент пересчета. Например, если продавали в порциях, и в карточке единицы Порция указано, что это 0.04 от литра, то будет сразу получен коэффициент пересчета порции в литры. В приведенном примере коэффициент 25 означает, что в литре содержится 25 порций по 40 мл.

    ![](/images/rmk/working/e44f3f142b26a2536850eb37c10406ab.png)

2.  Если прямой пересчет не найден, и при этом, продаваемая продукция учитывается в литрах, то использованная при продаже единица измерения ищется в дополнительных единицах измерения карточки товара. Например, продаваемая продукция учитывается в литрах, а продали Порцию. Тогда, в карточке товара должна быть дополнительная единица измерения с коэффициентом пересчета, который и будет использован.
3.  Если продаваемая продукция учитывается в бутлках, штуках, или иных единицах, отличных от литра, то для вычисления объема "штуки" будет использовано поле Объем карточки товара. Затем, исходя из полученного объема будет произведен разчет дополнительной единицы измерения. Например, если проданная продукция учитывается в бутылках объемом 0,375 литра, а в дополнительных единицах порция равна 0,1 бутылки, то итоговый коэффициент пересчета одной порции в литры будет 0,0375, т.е. одна порция будет равна 37,5 мл.

Кроме объема, в чеке, отправляемом в ЕГАИС, существенным является поле Price. ЕГАИС проверяет значение этого поля, чтобы оно не было меньше МРЦ.

На данный момент в этом поле передается учетная цена товара, соответствующего марке, пересчитанной в литры. Например, если бутылка объемом 0,5 литра имеет розничную цену 1300 рублей, то в чеке будет указана цена 2600 рублей.

Если при продаже использовалась не обобщенная карточка товара, а карточка конкретного алкоголя не была расценена, то будет использована розничная цена обобщенной карточки, пересчитанной на литр продукции.