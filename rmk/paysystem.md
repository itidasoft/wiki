---
title: Платежные системы
description: Айтида РМК
published: true
date: 2022-08-14T21:33:01.518Z
tags: банк, сбп, эквайринг, платежные карты
editor: markdown
dateCreated: 2022-08-14T21:32:34.305Z
---

Модуль регистрации продаж 2 позволяет использовать несколько платежных систем, обеспечивающих прием денежных средств в оплату чеков. Платежная система – это тип оборудования, работающий под управлением профиля платежной системы.

# Профиль оборудования для платежных систем.

В справочнике профилей оборудования есть возможность создать профиль для платежной системы.

![Изображение выглядит как текст Автоматически созданное описание](/images/rmk/paysystem/bde39275bf0aedcfef55a0c7f0f3cf2c.png)

Профиль платежной системы может содержать следующие обработки.

![Изображение выглядит как текст Автоматически созданное описание](/images/rmk/paysystem/a04859918154b97ef1ca01cd9e68e14f.png)

Обязательными к реализации являются следующие обработки:

1.  **Расчет суммы оплаты**. Обработка вызывается:
    -  в момент ввода кассиром суммы оплаты для платежной системы;
    -  в момент нажатия кнопки распределения суммы оплаты для вида оплаты.

        Обработка должна выполнить проверку вводимой суммы и, при необходимости, ограничить её необходимым значением. Значение, которое будет возвращено обработкой будет использовано в качестве значения платежа. Например, если есть ограничения на сумму операции, то обработка должна вернуть меньшую из суммы к оплате и суммы ограничения. Если ограничений нет, то обработка должна вернуть переданную ей сумму к оплате.

2.  **Выполнить оплату**. Обработка вызывается в момент осуществления платежа. Платежи производятся непосредственно перед печатью чека. Если платеж завершился ошибкой, например, карта клиента не была прочитана, то печать чека будет отменена. Если платежная система подразумевает использование устройств для выполнения платежа (банковский терминал), или генерацию кодов для отображения покупателю (система быстрых платежей), то обработка должна выполнить необходимые действия по приему платежа и вернуть **Истину**, в случае успеха. Иначе - **Ложь**.
3.  **Отменить оплату**. Обработка вызывается для отмены оплаты (не возврата). Обработка должна выполнить необходимые действия по отмене платежа и вернуть **Истину**, в случае успеха, иначе - **Ложь**.
4.  **Имя устройства ПС**. Обработка вызывается в карточке торгового оборудования для определения названия устройства. Обработка должна возвращать строку с названием, для отображения в карточке оборудования в поле **Устройство**. Обработка получает индекс устройства и по индексу должна вернуть название устройства.
5.  **Количество зарегистрированных устройств**. Обработка вызывается в карточке торгового оборудования, для заполнения списка доступных устройств. Обработка должна возвращать положительное число, равное количеству устройств, зарегистрированных в драйвере.

    Остальные обработки не являются обязательными к реализации и могут быть реализованы для выполнения дополнительных действий.

6.  **Инициализация ПС**. Вызывается в момент запуска модуля продаж и загрузки профиля ПС.
7.  **Открытие смены в ПС**. Вызывается в момент открытия смены в модуле продаж.
8.  **Закрытие смена в ПС**. Вызывается в момент закрытия смены в модуле продаж. Не вызывается при печати z-отчета на ККТ.
9.  **Текст ошибки драйвера ПС**. В случае наличия ошибок обработка должна возвращать текст последней возникшей ошибки драйвера.
10. **Последняя ошибка драйвера ПС**. В случае наличия ошибок обработка должна возвращать числовой код возникшей ошибки драйвера.
11. **Признак наличия ошибки**. В случае наличия ошибки обработка должна вернуть Истину.
12. **Наименование модели ПС**. Обработка может возвращать строку с названием модели используемого оборудования.
13. **Свойства драйвера**. Если используется сторонний драйвер оборудования, у которого могут быть заданы свойства, то обработка должна вызывать окно настроек драйвера. Обработка вызывается из карточки оборудования при нажатии кнопки Свойства драйвера.
14. **Окончание работы с ПС**. Обработка вызывается при завершении работы модуля продаж.

Всем обработкам передается набор переменных, необходимый для выполнения действий.

## Переменные, определяемые для профиля платежной системы.

| **Название переменной**        | **Описание**                                                                                                                                                                                             |
|--------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| КОДОБОРУДОВАНИЯ / code         | Строка. Код карточки оборудования платежной системы.                                                                                                                                                     |
| НОМЕРУСТРОЙСТВА / devicenumber | Число. Номер устройства из карточки оборудования.                                                                                                                                                        |
| СКЛАД / storage                | Строка. Код склада из карточки оборудования.                                                                                                                                                             |
| ДЕНЕЖНЫЙКАРМАН / moneybox      | Строка. Код денежного кармана из карточки оборудования.                                                                                                                                                  |
| ФИРМА / firm                   | Строка. Код фирмы из карточки оборудования.                                                                                                                                                              |
| НОМЕРФР / frnumber             | Строка. Номер ФР из карточки оборудования.                                                                                                                                                               |
| ФРКОДОБОРУДОВАНИЯ / frcode     | Строка. Код карточки оборудования ФР, соответствующий номеру ФР для текущего РМ.                                                                                                                         |
| ИДКЛИЕНТА / clientid           | Строка. ИД клиента из карточки оборудования.                                                                                                                                                             |
| ИДБАНКА / bankid               | Строка. ИД банка из карточки оборудования.                                                                                                                                                               |
| КОДВИДАОПЛАТЫ / paymentcode    | Строка. Код вида оплаты из карточки оборудования.                                                                                                                                                        |
| ВИДОПЛАТЫ / paymenttype        | Число. 0 – наличный вид оплаты, 1 - безналичный вид оплаты, 2 - оплата кредитом.                                                                                                                         |
| ОСНОВНАЯПС / defaultps         | Логическое. Истина, если ПС является платежной системой по умолчанию.                                                                                                                                    |
| СУММАКОПЛАТЕ / summa           | Сумма необходимая для оплаты чека. Передается в обработки расчета суммы оплаты, выполнения платежа и отмены платежа.                                                                                     |
| ВОЗВРАТ / return               | Логическое. Истина, если выполнятся возврат денежных средств. Передается в обработки выполнения платежа и отмены платежа.                                                                                |
| НОМЕРССЫЛКИ / referencenumber  | Строка. При отмене / возврате платежа – номер отменяемого платежа. При выполнении платежа, обработка может заполнить эту переменную, для сохранения номера, для последующей отмены или возврата платежа. |
| \_ОШИБКАВЫПОЛНЕНИЯ / \_ERROR   | Обработка должна установить значение Истина, если возникла ошибка выполнения.                                                                                                                            |

# Карточка оборудования платежной системы.

Для осуществления работы с платежной системой необходимо создать карточку оборудования платежной системы выбрав необходимый профиль и заполнив необходимый для работы параметры.

![Изображение выглядит как текст Автоматически созданное описание](/images/rmk/paysystem/7494a2d4b19ce47b5ac7757e5317bbed.png)

В поле **Тип оборудования** необходимо выбрать **Платежная система**. В поле **Профиль** будет предложен выбор из профилей платежных систем. В поле Краткое наименование необходимо ввести название платежной системы, которое будет отображаться в интерфейсе кассира.

![](/images/rmk/paysystem/805fa4ec0d6275e0337f00c5344d1650.png)

Если используемый драйвер подразумевает возможность подключения нескольких устройств, то в поле **Устройство** необходимо выбрать конкретное значение. Поля **Склад**, **Денежный карман**, **Фирма**, **Код вида** оплаты могут быть использованы для последующего создания документов или отчетов.

В поле **Номер ФР** можно выбрать ККТ, на которой будет распечатан слип платежной системы, если такой подразумевается драйвером.

Параметр **Использовать платежную систему для оплаты по умолчанию** укажет системе на то, что если кассир не задал ручного распределения суммы оплаты чека, а просто нажал на кнопку **Печать**, то весь остаток нераспределенной суммы будет направлен на эту платежную систему.

Параметры **IP адрес**, **номер порта**, **ИД клиента**, **ИД банка** могут быть использованы профилем по своему усмотрению. Например, для формирования QR кода СБП необходимы параметры ИД клиента и ИД банка, для построения ссылки для оплаты. Если вывод QR кода производится на специализированный дисплей, то потребуется номер порта, к которому подключен дисплей и т. п.

**Вид оплаты определяет**, какие денежные средства обслуживаются платежной системой. По этому признаку будет производиться деление ПС по видам оплаты в интерфейсе кассира.

Параметр **Платежная система может возвращать сдачу** укажет системе, что при использовании именно этой ПС для оплаты чека, указанная сумма может превышать сумму, необходимую к оплате. В этом случае будет формироваться сдача покупателю.
