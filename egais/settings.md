---
title: Настройка модуля ЕГАИС
description: Руководство по модулю ЕГАИС
published: true
date: 2022-07-25T22:02:36.027Z
tags: егаис, настройка модуля
editor: markdown
dateCreated: 2022-07-25T21:57:52.969Z
---

# Введение

За время, прошедшее с начала действия ЕГАИС для розничной торговли, сменилось несколько версий формата обмена данными с этой системой. По этой причине, в модуль ЕГАИС Айтиды были внесены существенные изменения, адаптирующие его работу к текущим требованиям.

## Краткий перечень внесенных изменений и расширений.

1.  Загрузка ТТН из ЕГАИС. В текущей версии поддерживается загрузка ТТН во всех версиях формата обмена с ЕГАИС. Начиная со второй версии формата изменения коснулись следующих элементов.
    1.  Признак упакованной продукции. Во второй версии формата этот признак устанавливается не на всю накладную, а на каждую строку продукции. Поэтому, в Айтиде было добавлено поле в список алко-кодов, указывающее, является ли продукция упакованной. По умолчанию, это поле инициализируется значением "не определено". В момент загрузки данных в новом формате это поле будет проставляться для ранее загруженной продукции. При отгрузке товара этот признак используется, только если у него было указано значение, отличное от "не определено". В противном случае, как и прежде, если продукция отгружается в дал, то считается что она не упакованная.
    2.  Признак типа организации. Во второй версии формата добавлены признаки, указывающие тип организации. Возможно 4 различных варианта:
        1.  Юридическое лицо – организация зарегистрированная в РФ, кроме ИП;
        2.  Физическое лицо – ИП, зарегистрированный в РФ;
        3.  Таможенный союз – организация из таможенного союза, кроме РФ;
        4.  Иностранная организация – организация из страны за пределами ТС.

            Для хранения этой информации в карточку контрагента были добавлены новые варианты типа организации. Для иностранных организаций убрана проверка на наличие ИНН.

            ![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/6c394606508d4e8fd09c751187922bf8.png)

2.  Отправка актов подтверждения. Теперь акты могут быть отправлены в двух версиях формата. Выбор зависит от версии, поддерживаемой получателем акта и настройкой УТМ в Айтиде.
3.  Теперь тип акта запоминается в документе приходная накладная, и его не позволяется менять после отправки в ЕГАИС.
4.  Розничная продажа не маркированного алкоголя и алкоголя маркированного марками в формате PDF417 производится с розничного регистра ЕГАИС. Для того, чтобы на этом регистре были остатки, их необходимо туда перемещать. Для упрощения перемещения продукции с оптового на розничный регистр, предусмотрен вариант формирования перемещения из данных приходной накладной. В розничный регистр перемещается фактическое количество продукции, указанное в документе.
5.  Розничная продажа маркированного марками в формате QR-code алкоголя производится с оптового регистра. Поэтому, такая продукция не перемещается в розничный регистр ЕГАИС.
6.  Реализованы все необходимые для розничной торговли запросы в ЕГАИС. Выбор типа запроса выведен в отдельное окно запроса. Так же добавлена возможность формирования дополнительного файла с кодами марок для отправки в личный кабинет ЕГАИС для проверки.
7.  В ответ на запрос остатков теперь формируется специальный документ Инвентаризация ЕГАИС. Этот документ не влияет на учет в Айтиде, но позволяет сверить учетные остатки с остатками в ЕГАИС и сформировать необходимые акты постановки на баланс и/или акты списания продукции.
8.  Отправка актов списания продукции на основании продаж (ДКС и вскрытия тары) разбивается на два акта. Один для маркированного марками в формате QR-code алкоголя с оптового регистра, второй для остального алкоголя с розничного регистра
9.  Отправка расходных накладных производится в текущем активном формате обмена.
10. В модуле регистрации продаж версии 1 и 2 есть возможность формирования документа Вскрытие тары и использования одной карточки товара для вскрытия тары и продажи продукции в розлив. Аналогично, при обмене с Фронтол можно использовать одну карточку товара для обеих операций.
11. Акт постановки на баланс поддерживает возможность ставить продукцию на баланс, как на розничный регистр ЕГАИС , так и на оптовый.
12. В актах постановки на баланс есть возможность выбора причины постановки на баланс, как того требует вторая версия формата обмена с ЕГАИС.
13. Акт списания продукции поддерживает возможность списывать продукцию, как с розничного регистра ЕГАИС , так и с оптового.
14. Добавлена возможность передавать продукцию с оптового регистра на розничный и обратно. Возможность реализуется документом Внутреннее перемещение, который может быть выгружен в ЕГАИС.
15. Согласно требованиям пивная продукция должна быть списана с баланса единым актом списания в конце дня, вместо по-чекового списания. Для этих целей ДКС, содержащие пивную продукцию, могут быть переданы в ЕГАИС в виде актов списания продукции.
16. При обработке ошибок, которые могут возникать при отправке данных в ЕГАИС выводится причина ее возникновения, которую возвращает УТМ; так же, при желании, может быть просмотрен/скопирован текст, вызвавший ошибку, т.е. тот, который был отправлен в УТМ и вызвал ошибку.
17. Запросы, которые нельзя часто отправлять в ЕГАИС, например, запрос остатков марок, могут формировать очередь запросов, которая может автоматически обрабатываться службой Айтиды.

# Предварительные настройки

ЕГАИС ИД – это идентификатор подразделения организации в ФС РАР.

Узнать ЕГАИС ИД можно на странице УТМ в любом браузере.

.

## ЕГАИС-ИД {#егаис-ид}

Чтобы узнать свой ЕГАИС ИД через аппаратный ключ, необходимо подключить к ПК носитель с криптографической электронной подписью (КЭП), открыть утилиту для работы с аппаратными носителями и перейти на вкладку «Ключи и сертификаты». При этом потребуется ввести пароль пользователя RSA-ключа (как это показано на картинке ниже):

![](/images/egais/settings/31d3f0d9d3e20ddfb30f2ecb25a66d92.png)

После того, как пароль введён, в окне утилиты необходимо кликнуть двойным щелчком мыши по иконке с сертификатом (откроется сам сертификат), перейти на вкладку «Состав» в окне «Сертификат», затем выбрать поле «Субъект».

Значение «CN» тут и будет искомым идентификатором (см. картинку ниже):

![](/images/egais/settings/d509d7891adcb65b3875328294391921.png)

ЕГАИС-ИД можно узнать также в браузере, на странице УТМ в разделе сертификатов RSA:

![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/fc4c114ba9b02b79e6eb6d31eab118bf.png)


# Подключение и настройка модуля ЕГАИС

Для подключения модуля ЕГАИС необходимо добавить в систему меню программы пункт *Модуль ЕГАИС* (название пункта может быть изменено партнёром по его усмотрению). В дистрибутивной базе данный пункт расположен в меню Сервис. Для самостоятельного подключения этого пункта необходимо использовать команду *DO FORM egaisform*.

![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/02da068263182f3647e3229db8d9d7bf.png)

Для отображения добавленного пункта в меню необходимо перезапустить систему Айтида. Так же, необходимо добавить пункт меню для вызова формы сопоставления товаров с алкокодами ЕГАИС. Для этого необходимо использовать команду `DO FORM egaissubst.`

Сопоставления товаров из справочника с алкокодами необходимо, т.к. все данные, приходящие из ЕГАИС содержат в качестве идентификатора товара алкокод. Для перевода алкокода в товар из справочника необходимо связать его с карточкой товара. С одной карточкой товара может быть связано несколько алкокодов. В этом случае, продукция с разыми алкокодами будет идентифицироваться в Айтиде с одним товаром. Такие связи часто нужны для пивной продукции, для которой существует несколько производителей. У каждого производителя или каждого завода одного производителя, свой алкокод для продукции. А в продаже это один товар.

![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/9fb933c5e069bf2b36c0af21d16c4fda.png)

Первый запуск модуля необходимо произвести от имени пользователя с правами администратора. В этом случае будет доступен функционал по настройке модуля:

![Изображение выглядит как стол Автоматически созданное описание](/images/egais/settings/d8f2ddea158c6ac765fc81153232e449.png)

Для корректной работы с модулем в параметрах системы необходимо установить признак **Колонки для работы с ЕГАИС**.

![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/5a966d49748e12d3fb02b009ca58e236.png)

Настройка модуля производится для каждого склада (торговой точки), на которых предполагается обмен данными с ЕГАИС. В окне настройки можно указать следующие параметры:

![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/36581de275ab70f4110e274891b49723.png)

1.  Раздел **Системные параметры** заполняется автоматически при установке обновления системы Айтида и содержит тексты обработок, выполняющих необходимые функции по взаимодействию с транспортным модулем ЕГАИС. Раздел доступен при запуске системы в режиме конфигурации при наличии NFR лицензии/сублицензии.
2.  Кнопки **Добавить УТМ** **в список, Изменить название УТМ в списке** и **Удалить УТМ** **из списка** позволяют формировать список УТМ для работы.
3.  **IP Адрес** и **порт доступа** транспортного модуля ЕГАИС. В этих полях необходимо указать IP адрес компьютера, на котором установлен транспортный модуль, и порт доступа к нему. Если транспортный модуль установлен на том же компьютере, что и Айтида, и других рабочих мест нет, то можно указать значение 127.0.0.1.
4.  В поле **ЕГАИС ИД** необходимо указать идентификатор в системе ЕГАИС для используемого УТМ (см. раздел [**ЕГАИС-ИД**](#егаис-ид)).
5.  В поле **Время отклика** можно задать максимальное время ожидания ответа УТМ в секундах. По умолчанию, если значение не указано, то время ожидания ответа составляет 100 секунд. Обычно, этого времени УТМ достаточно для обработки больших документов. Если за указанное время ответ от УТМ не был получен, то в Айтиде не будет определен результат операции и будет выведено сообщение об ошибке "**Ответ сервера не был распознан**". В этой ситуации необходимо почистить базу данных УТМ. Возможно, что придется переустановить УТМ и/или увеличить время ожидания ответа от УТМ.
6.  В разделе **Папки** **для создания новых объектов** необходимо выбрать папки справочников, в которых будут создаваться новые товары и контрагенты. Данные, загружаемые из транспортного модуля, содержат в себе не только накладные поставщиков, но и необходимые реквизиты производителей, импортёров, поставщиков товаров, а также описание самих товаров. При загрузке неопознанные контрагенты и товары будут созданы в указанных папках. При создании новых карточек товара будет учитываться, какая группа ресурсов указана в выбранной папке. В новые карточки будет перенесена информация заданная в группе ресурсов, так. Как если бы эта группа была выбрана в карточке товара интерактивным путем.

![Изображение выглядит как текст Автоматически созданное описание](/images/egais/settings/1dcdaac33aa9943d837001e07e83e6e4.png)

1.  В разделе **Параметры создаваемых документов** необходимо выбрать **Организацию** и **Склад**, на которые будут создаваться приходные накладные. Если эти параметры не будут выбраны, то в процессе создания документов значения будут подставлены из настроек пользователя, осуществляющего операцию загрузки.
2.  В **Прочих параметрах** можно изменять работу алгоритма загрузки:
3.  Установка флага **Изменять карточки контрагентов**  позволяет производить автоматическое обновление реквизитов контрагентов в процессе загрузки данных. Идентификация загружаемых контрагентов (производителей/импортёров/поставщиков) производится по идентификатору ЕГАИС, а в случае его отсутствия по ИНН и КПП.
4.  При установленном флаге **Пересоздавать не проведенные накладные** при повторной загрузке данных имеющиеся в Айтиде документы будут удалены и добавлены снова. Если флаг не установлен, такие документы будут оставлены без изменений, и новые созданы не будут. При этом, пользователь увидит сообщение, что документ присутствует в системе, но пересоздан не был.

>   Внимание! При удалении документа будут удалены также и все изменения, внесённые в документ после его загрузки из ЕГАИС.
{.is-warning}


1.  Если установлен флаг **Удалять успешно загруженные данные**, после загрузки файлы из транспортного модуля будут удаляться. Удаление загруженных файлов позволяет уменьшить размер базы данных транспортного модуля и не загружать повторно данные в Айтиду.
2.  Если установлен флаг **Сопоставлять товары после загрузки данных**, то в случае, если после загрузки данных добавились новые товары, которых еще нет в справочнике товаров Айтиды, будет выведено окно для осуществления сопоставления/создания карточек товаров с алкокодами, пришедшими из ЕГАИС. Если флаг не установлен, тогда форма сопоставления не будет выведена. В этом случае, сопоставление можно будет выполнить позже – при проверке загруженных накладных, или вызвав форму сопоставления из меню.
3.  Если установлен флаг **Использовать формат обмена с ЕГАИС версии 4**, то исходящие ТТН будут передаваться в четвертом формате ЕГАИС.
4.  Если установлен флаг **Ожидать подтверждения отправки перемещения по приходной накладной**, то в списке приходных накладных модуля ЕГАИС будут отображаться не только те накладные, по которым есть не подтвержденные акты, но и те, по которым либо не было отправки перемещения в розничный регистр ЕГАИС, либо оно еще не было подтверждено ЕГАИС.
5.  Установка флага **Включать маркированный алкоголь в акты списания по ДКС и ВТ** укажет системе на необходимо обработки крепкого алкоголя, при формировании актов списания, отправляемых в ЕГАИС на основании ДКС и ВТ.
